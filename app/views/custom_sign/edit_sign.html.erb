<% content_for :stylesheets do %>
    <%= stylesheet_link_tag('select2', 'spectrum', 'customisation', 'stylesheet', 'jquery-fancybox', 'jquery.qtip', 'joyride-1.0.5') %>
<% end %>
<% content_for :javascripts do %>
    <%= javascript_include_tag('select2.min', 'spectrum', 'customisation', 'fabric', 'jquery-base64-min', 'jquery-fancybox-pack', 'jquery-ui-1.8.23.custom.min', 'jquery.qtip.min', 'modernizr.mq', 'jquery.joyride-1.0.5') %>
<% end %>
<%= params.to_yaml %>

<!--

data:image/png;base64,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

-->

<div onclick="$('#encoded_image').text(canvas.toDataURL());">Get BASE64 string</div>
<div style="padding: 10px; width: 20000px; white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
        white-space: -pre-wrap;      /* Opera 4-6 */
        white-space: -o-pre-wrap;    /* Opera 7 */
        white-space: pre-wrap;       /* css-3 */
        word-wrap: break-word;       /* Internet Explorer 5.5+ */
        word-break: break-all;
        white-space: normal;" id="encoded_image"></div>
<div id="loadingOverlay"></div>
<div id="tourOverlay"></div>
<div id="canvasZoomWrapper">
  <div class="minorFunctions" id="minorFunctions">
    <div class="function" id="startagain">Start Again</div>
    <div class="function" id="clearCanvas">Clear Canvas</div>
    <div class="function" id="startTutorial">Quick Tutorial</div>
    <% if current_refinery_user %>
        <div class="function" id="saveCanvas">Save</div>
        <div class="function" id="loadCanvas">Load</div>
    <% end %>
  </div>
  <div style="position: absolute; top: 90px; color: white; left: 50px; display: none;">Canvas Size : Width
    : <%= (params[:width].to_f)/10 %>cm X Height : <%= (params[:height].to_f)/10 %>cm
  </div>

  <canvas style="z-index: 10;" id="my-canvas" width="600" height="600"></canvas>


  <!--Object buttons-->
  <div class="majorFunctions" id="majorFunctions">

    <!--Add Text-->
    <div class="buttonContainer">
      <div class="button addText overlay" id="addText">Add Text</div>
      <div class="menu addTextMenu" id="addTextMenu">
        <div class="arrow"></div>
        <div class="function textBold" id="textBold" title="Bold"></div>
        <div class="function textItalic" id="textItalic" title="Italic"></div>
        <div class="function textUnderline" id="textUnderline" title="Underline"></div>
        <div class="function textStrikethrough" id="textStrikethrough" title="Strikethrough"></div>
        <div class="function alignLeft" id="alignLeft" title="Left Align"></div>
        <div class="function alignCenter" id="alignCenter" title="Centre Align"></div>
        <div class="function alignRight" id="alignRight" title="Right Align"></div>
        <select class="fontFamily" id="fontFamily">
          <optgroup label="Serif">
            <option value="ArvoRegular">Arvo</option>
            <option value="DroidSerifRegular">Droid Serif</option>
            <option value="RokkittRegular">Rokkitt</option>
          </optgroup>
          <optgroup label="Sans Serif">
            <option value="OpenSansRegular" selected="selected">Open Sans</option>
            <option value="OswaldRegular">Oswald</option>
            <option value="QuestrialRegular">Questrial</option>
          </optgroup>
          <optgroup label="Display">
            <option value="ChewyRegular">Chewy</option>
            <option value="FredokaOneRegular">Fredoka One</option>
            <option value="SpecialEliteRegular">Special Elite</option>
          </optgroup>
          <optgroup label="Handwriting">
            <option value="ComingSoonRegular">Coming Soon</option>
            <option value="PacificoRegular">Pacifico</option>
            <option value="PermanentMarkerRegular">Permanent Marker</option>
          </optgroup>
        </select>
        <input type="text" class="showPaletteOnly" value="#000000"/>

        <div class="function engraved" id="textEngraved" title="No paint, only engraved">
          Engraved, no paint
        </div>
      </div>
    </div>

    <!--Add Shape-->
    <div class="buttonContainer">
      <div class="button addShape" id="addShape">Add Shape</div>
      <div class="menu addShapeMenu" id="addShapeMenu">
        <div class="arrow"></div>
        <select class="shapeSelect" id="shapeSelect">
          <option></option>
          <% get_sign_graphic_category.each do |cat| %>
              <optgroup label="<%= cat.category_name %>">
                <% get_sign_graphics_for_category(cat.id).each do |g| %>
                    <option value="id_<%= g.id %>"><%= g.title %></option>
                <% end %>
              </optgroup>
          <% end %>
          <optgroup label="Animals">
            <option value="ant">Ant</option>
            <option value="bear">Bear</option>
            <option value="chicken">Chicken</option>
            <option value="cow">Cow</option>
            <option value="crab">Crab</option>
            <option value="crow">Crow</option>
            <option value="deadbird">Dead Bird</option>
            <option value="seahorse">Seahorse</option>
            <option value="squirrel">Squirrel</option>
          </optgroup>
        </select>
        <input type="text" class="showPaletteOnly" value="#000000"/>

        <div class="function engraved" id="shapeEngraved" title="No paint, only engraved">
          Engraved, no paint
        </div>
      </div>
    </div>

    <!--Add Border-->
    <div class="buttonContainer">
      <div class="button addBorder" id="addBorder">Add Border</div>
      <div class="menu addBorderMenu" id="addBorderMenu">
        <div class="arrow"></div>
        <select class="borderSelect" id="borderSelect">
          <option></option>
          <option value="noborder">No Border</option>
          <option value="single">Single</option>
          <option value="double">Double</option>
          <option value="scalloped">Scalloped</option>
        </select>
        <label>Border thickness:</label>

        <div id="borderThicknessSlider"></div>
        <input type="text" class="showPaletteOnly" id="borderColor" value="#000000"/>

        <div class="function engraved" id="borderEngraved" title="No paint, only engraved">
          Engraved, no paint
        </div>
      </div>
    </div>

    <!--Price-->
    <div class="priceWrapper">
      <span class="price">&pound;<%= number_with_precision(@sign_data.price, :precision => 2) %></span><span class="inclVAT"> Incl. VAT</span>
    </div>

    <!--Add to Basket button-->
    <div class="addToBasket" id="addToBasket">Add to Basket</div>
  </div>

  <!--Tool palette-->
  <div class="toolPalette" id="toolPalette">
    <div class="grabHandle" id="grabHandle"></div>
    <div class="label">
      Undo/Redo
    </div>
    <div class="toolRow">
      <div class="tool" id="undo" title="Undo"></div>
      <div class="tool" id="redo" title="Redo"></div>
    </div>
    <div class="label">
      Delete/Clone
    </div>
    <div class="toolRow">
      <div class="tool disabled" id="deleteActiveObject" title="Delete"></div>
      <div class="tool disabled" id="cloneActiveObject" title="Clone"></div>
    </div>
    <div class="label">
      Zoom = <span id="canvasScale">100%</span>
    </div>
    <div class="toolRow">
      <div class="tool" id="zoomIn" title="Zoom In"></div>
      <div class="tool" id="zoomOut" title="Zoom Out"></div>
    </div>
    <div class="label">
      Arrange
    </div>
    <div class="toolRow">
      <div class="tool disabled" id="bringForward" title="Bring Forward"></div>
      <div class="tool disabled" id="sendBackwards" title="Send Backwards"></div>
    </div>
    <div class="label">
      Flip Object
    </div>
    <div class="toolRow">
      <div class="tool disabled" id="flipY" title="Flip Vertical"></div>
      <div class="tool disabled" id="flipX" title="Flip Horizontal"></div>
    </div>
    <div class="label">
      Guides
    </div>
    <div class="toolRow">
      <div class="tool" id="toggleScrewHoles" title="Show Screw Holes"></div>
      <div class="tool" id="toggleMargins" title="Show Margins"></div>
    </div>
  </div>
</div>
<div id="hiddenForm">
  <form action="/custom_sign/save_dialog" method="POST" id="customSignForm">
    <input type="hidden" id="sign_data" name="sign_data" value="">
    <input type="hidden" id="svg_data" name="svg_data" value="">
    <input type="hidden" id="sign_data_id" name="sign_data_id" value="<%= @sign_data.id %>">
    <input type="hidden" id="account_id" name="account_id" value="<%= current_refinery_user ? current_refinery_user.id : '' %>">
    <input type="hidden" id="product_id" name="product_id" value="<%= @sign_data.spree_product_id %>">
    <input type="hidden" id="quantity" name="quantity" value="1">
    <input type="hidden" id="base64png" name="base64png" value="">
    <input type="hidden" id="name" name="name" value="">
    <input type="hidden" id="description" name="description" value="">
    <input type="hidden" id="calculated_price" name="calculated_price" value="<%= @sign_data.price %>">
  </form>
</div>
<ol id="tourSteps">
  <li data-id="addText" data-text="Next - Create a shape"><h4>Add Text <span>(1 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
  <li data-id="addShape" data-text="Next - Add a Border"><h4>Add Shape <span>(2 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
  <li data-id="addBorder" data-text="Next - Add to Basket"><h4>Add Border <span>(3 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
  <li data-id="addToBasket" data-text="Finish Tour"><h4>Add to Basket <span>(4 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
</ol>
<div style="display: none;">
  <img id="engravedbg" src="/assets/engraved_bg.png">
</div>
<script src="/assets/aligning_guidelines"></script>
<script src="/assets/centering_guidelines"></script>

<script>

    var undoStack = [];
    var redoStack = [];
    var currentState = [];
    var canvas_track_changes = false;
    var ignor_last_action = true;
    var mask_svg_url = '';
    var canvasMargin = $('.canvas-container').css("margin-left");
    var base64png = "";

    var canvas = null;
    // added to fix de-authentication when posting ajax : Doug

    (function () {

        canvas = new fabric.Canvas('my-canvas');

        initAligningGuidelines(canvas);
        initCenteringGuidelines(canvas);

        // Update the two variables below with usable area size
        var canvasWidth = ($(window).width() - 120);
        var canvasHeight = ($(window).height() - 300);
        var SignWidth = 100;
        SignWidth = <%= @sign_data.width %>;
        var SignHeight = 100;
        SignHeight = <%= @sign_data.height %>;
        // alert(SignHeight);

        // track the change activity on canvas


        if (SignWidth / canvasWidth > SignHeight / canvasHeight) {
            canvasHeight = (canvasWidth / SignWidth) * SignHeight;
        }
        else {
            canvasWidth = (canvasHeight / SignHeight) * SignWidth;
        }

        var canvasScale = 1.0;
        var placeholderText = 'Double click to change me...';

        canvas.setWidth(canvasWidth);
        canvas.setHeight(canvasHeight);

        // alert(canvasWidth);
        // alert(canvasHeight);

        // canvas.backgroundImageStretch = true;

        var bg_image_url = '';


        //this is where the background image is set. Need to think about how to store and recall this.
        <% background_image = @sign_data.get_background_image %>

        <% if background_image.nil? %>

//        canvas.setBackgroundImage('/assets/customisation/brass_test.jpg', function () {
////            canvas.item(0).scaleToWidth(canvas.getWidth());
//            canvas.renderAll();
//        });

        bg_image_url = '/assets/customisation/brass_test.jpg';

        <% else %>

        bg_image_url = '<%= background_image.attachment.url(:product) %>';
        canvas.setBackgroundImage(bg_image_url, function () {
            //canvas.setBackgroundImage('/assets/customisation/brass.jpg', function () {

            canvas.renderAll();
        });

        <% end %>

        canvas_track_changes = false;
        console.log('canvas_track_changes : ' + canvas_track_changes);

        ignor_last_action = true;

        fabric.Image.fromURL(bg_image_url, function (oImg) {
            if ((canvas.width / canvas.height) > (oImg.width / oImg.height)) {
                oImg.scaleToWidth(canvasWidth);
            }
            else {
                // portrait
                oImg.scaleToHeight(canvasHeight);
            }

            oImg.top = canvasHeight / 2;
            oImg.left = canvasWidth / 2;

            oImg.selectable = false;
            canvas.add(oImg);
        });

        // set the mask for the sign

        mask_svg_url = "<%= @sign_data.get_mask %>";

        applyMask();

        canvas_track_changes = true;
        console.log('canvas_track_changes : ' + canvas_track_changes);

        //canvas.renderAll();

        // setup complete

        SetupCanvasEventHooks(canvas);

        //canvas.clear();

        $('<textarea rows="1" cols="1" id="textArea"></textarea>').appendTo('.canvas-container');

        $("#sign_data").val('<%= @sign_data.sign_data %>');
        if ($("#sign_data").val() != '') {
            //alert("Saved sign loaded!");
            var jsn = $.base64.decode($("#sign_data").val());
            canvas.loadFromJSON(jsn);
            $("#name").val("<%= @sign_data.name %>");
            $("#description").val("<%= @sign_data.description %>");
            //var svg = canvas.toSVG();
            //window.open(canvas.toDataURL('png'));
        }


        $("#addToBasket").click(function () {
            //serialize the custom sign data
            //add this to the form field
            var json = JSON.stringify(canvas);
            // alert(json);
            var svg_data = canvas.toSVG();
            // alert(svg_data);
            var custom_data = $.base64.encode(json);
            $("#sign_data").val(custom_data);
            $("#svg_data").val(svg_data);
            var id = $("#sign_data_id").val();
            var account_id = $("#account_id").val();
            var name = $("#name").val();
            var description = $("#description").val();
            var calculated_price = $("#calculated_price").val();

            // alert("about to post sign to basket");
            $.ajax({
                type: "POST",
                url: "/custom_sign/save_sign",
                data: { authenticity_token: $("meta[name='csrf-token']").attr("content"), id: id, sign_data: custom_data, base64png: canvas.toDataURL({multiplier: 1}), svg_data: svg_data, account_id: account_id, name: name, description: description, calculated_price: calculated_price }
            }).done(function (msg) {

                        $("#customSignForm").prepend("<input type='hidden' name='authenticity_token' value='" + $("meta[name='csrf-token']").attr("content") + "'>")
                        $("#customSignForm").attr("action", "/orders/populate");
                        //submit the form to the basket
                        $("#customSignForm").submit();
                    }
            ).fail(function () {
                        alert("error");
                    }
            );
            //change submit path of the form
            //$("#customSignForm").attr("action", "/orders/populate");
            //submit the form to the basket
            //$("#customSignForm").submit();
        });

        $("#saveCanvas").click(function () {
            json = JSON.stringify(canvas);
            var svg_data = canvas.toSVG();
            var custom_data = $.base64.encode(json);
            $("#sign_data").val(custom_data);
            $("#svg_data").val(svg_data);
            //this is where custom_sign/save_sign is called
            $.fancybox.open({href: '/custom_sign/save_dialog',
                title: 'Save Custom Sign',
                type: 'iframe',
                autoSize: 'false',
                minWidth: '640px',
                minHeight: '480px',
                maxWidth: '640px',
                maxHeight: '480px',
                width: '640px',
                height: '480px'});
            //$.fancybox.open( {href : '/assets/feature-image-1.jpg', title : 'Save Custom Sign', type : 'iframe', width : '640px', height : '480px'} );
            //jQuery.ajax("/custom_sign/save_sign?custom_data=" + $.base64.encode(json));
        });

        $("#loadCanvas").click(function () {
            //canvas.loadFromJSON(json);
            $.fancybox.open({href: '/custom_sign/load_sign_list/<%= session[:account_id].nil? ? "0" : session[:account_id].id.to_s %>',
                title: 'Save Custom Sign',
                type: 'iframe',
                autoSize: 'false',
                minWidth: '640px',
                minHeight: '480px',
                maxWidth: '640px',
                maxHeight: '480px',
                width: '640px',
                height: '480px'});
        });

        $('#addText').click(function () {
            $('#addTextMenu').show();
            $('#addShapeMenu').hide();
            $('#addBorderMenu').hide();
            var textValue = $('#textArea').val();
            var fontFamily = $('#fontFamily').val();
            var color = $('.showPaletteOnly').val();
            var text = new fabric.Text(placeholderText, {
                fontFamily: fontFamily,
                fill: color,
                left: canvasWidth / 2,
                top: canvasHeight / 2
            });

            text.hasRotatingPoint = true;
            text.set({
                borderColor: 'cyan',
                cornerColor: 'cyan',
                fontWeight: "normal"
            });


            text.scale(canvasScale);

            // make text selected
            canvas.setActiveObject(text);

            canvas.add(text);

            canvas.renderAll();

        });

        $('#addShape').click(function () {
            $('#addShapeMenu').show();
            $('#addTextMenu').hide();
            $('#addBorderMenu').hide();
        });

        $('#addBorder').click(function () {
            $('#addBorderMenu').show();
            $('#addTextMenu').hide();
            $('#addShapeMenu').hide();
        });

        canvas._onMouseUp = (function () {
            var activeObject = canvas.getActiveObject();
            return function (e) {
                canvas.__onMouseUp(e);
//                if (activeObject && activeObject.type === 'text') {
//                    var currentText = activeObject.getText();
//                    if (currentText = "") {
//                        currentText = " ";
//                    }
//
//                    canvas.fire('object:mouseup', { target: activeObject }, e);
//                    $('#textArea').focus().val(currentText);
//                    if (currentText == placeholderText) {
//                        $('#textArea').val('');
//                    }
//                }
            };
        })(canvas.setActiveObject);

        function dblClickHandler() {
            var activeObject = canvas.getActiveObject();

            if (canvas.getActiveObject() && canvas.getActiveObject().type === 'text') {
                var activeObjectFontFamily = canvas.getActiveObject().fontFamily;
                $('#fontFamily').val(activeObjectFontFamily).trigger("change");
                $('#textArea').val(activeObject.text)

                // console.log('-webkit-transform : rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')');

                $('#textArea').css({
                    '-webkit-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                    '-moz-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                    '-0-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                    '-ms-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                    display: 'block',
                    fontFamily: activeObject.fontFamily,
                    fontSize: activeObject.fontSize,
                    height: activeObject.height,
                    left: activeObject.left - activeObject.width / 2,
                    lineHeight: activeObject.lineHeight,
                    textAlign: activeObject.textAlign,
                    top: activeObject.top - activeObject.height / 2,
                    width: activeObject.width,
                    zIndex: 100
                });

                canvas.observe('object:modified', function () {
                    $('#textArea').css({
                        '-webkit-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                        display: 'block',
                        height: activeObject.height,
                        left: activeObject.left - activeObject.width / 2,
                        top: activeObject.top - activeObject.height / 2,
                        width: activeObject.width
                    });
                });
                canvas.observe('object:moving', function () {
                    $('#textArea').css({
                        display: 'none'
                    });
                });
                canvas.observe('object:scaling', function () {
                    $('#textArea').css({
                        display: 'none'
                    });
                });
                canvas.observe('object:rotating', function () {
                    $('#textArea').css({
                        display: 'none'
                    });
                });
                canvas.observe('after:render', function () {
                    $('#textArea').css({
                        fontFamily: activeObject.fontFamily,
                        fontStyle: activeObject.fontStyle,
                        fontWeight: activeObject.fontWeight,
                        height: activeObject.height,
                        left: activeObject.left - activeObject.width / 2,
                        textAlign: activeObject.textAlign,
                        textDecoration: activeObject.textDecoration,
                        top: activeObject.top - activeObject.height / 2,
                        width: activeObject.width
                    });
                    if (activeObject.fontFamily === 'PacificoRegular') {
                        $('#textArea').css({
                            marginTop: activeObject.scaleY * 0.25 + 'em'
                        });
                    }
                    else {
                        $('#textArea').css({
                            marginTop: 0
                        })
                    }
                });
            }

        }

        fabric.util.addListener(fabric.document, 'dblclick', dblClickHandler);
        // fabric.util.removeListener(canvas_ctx.upperCanvasEl, 'dblclick', dblClickHandler);

//        Set Tab key to deselect current text object if focus is in text area
        $('#textArea').live('keyup', function (e) {
            var keyCode = e.keyCode || e.which;
            if (keyCode == 9) {
                e.preventDefault();

                canvas.deactivateAll().renderAll();
                $('#textArea').val('').blur();
            }
        });

        canvas.observe('selection:cleared', function (e) {
            $('#textArea').val('').css({'display': 'none'});
        });

        canvas.observe('object:selected', function (e) {
            var activeObject = canvas.getActiveObject();
            var activeObjectFill = canvas.getActiveObject().fill;
            /*
             if (canvas.getActiveObject() && canvas.getActiveObject().type === 'text') {
             var activeObjectFontFamily = canvas.getActiveObject().fontFamily;
             $('#fontFamily').val(activeObjectFontFamily).trigger("change");
             $('#textArea').val(activeObject.text).css({
             '-webkit-transform': 'rotate(' + activeObject.theta * 180 / Math.PI + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
             '-moz-transform': 'rotate(' + activeObject.theta * 180 / Math.PI + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
             '-0-transform': 'rotate(' + activeObject.theta * 180 / Math.PI + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
             '-ms-transform': 'rotate(' + activeObject.theta * 180 / Math.PI + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
             display: 'block',
             fontFamily: activeObject.fontFamily,
             fontSize: activeObject.fontSize,
             height: activeObject.height,
             left: activeObject.left - activeObject.width / 2,
             lineHeight: activeObject.lineHeight,
             textAlign: activeObject.textAlign,
             top: activeObject.top - activeObject.height / 2,
             width: activeObject.width,
             zIndex: 100
             });
             canvas.observe('object:modified', function () {
             $('#textArea').css({
             '-webkit-transform': 'rotate(' + activeObject.theta * 180 / Math.PI + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
             display: 'block',
             height: activeObject.height,
             left: activeObject.left - activeObject.width / 2,
             top: activeObject.top - activeObject.height / 2,
             width: activeObject.width
             });
             });
             canvas.observe('object:moving', function () {
             $('#textArea').css({
             display: 'none'
             });
             });
             canvas.observe('object:scaling', function () {
             $('#textArea').css({
             display: 'none'
             });
             });
             canvas.observe('object:rotating', function () {
             $('#textArea').css({
             display: 'none'
             });
             });
             canvas.observe('after:render', function () {
             $('#textArea').css({
             fontFamily: activeObject.fontFamily,
             fontStyle: activeObject.fontStyle,
             fontWeight: activeObject.fontWeight,
             height: activeObject.height,
             left: activeObject.left - activeObject.width / 2,
             textAlign: activeObject.textAlign,
             textDecoration: activeObject.textDecoration,
             top: activeObject.top - activeObject.height / 2,
             width: activeObject.width
             });
             if (activeObject.fontFamily === 'PacificoRegular') {
             $('#textArea').css({
             marginTop: activeObject.scaleY * 0.25 + 'em'
             });
             }
             else {
             $('#textArea').css({
             marginTop: 0
             })
             }
             });
             }
             */

            if (!activeObject.get("engraved")) {
                $('.showPaletteOnly').spectrum("set", activeObjectFill);
            }
        });

        var textEl = $('#textArea');
        if (textEl) {
            textEl.keyup(function (e) {
                var activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type == "text") {

                    canvas.fire('object:modified', { target: canvas.getActiveObject() });

                    if (this.value == "") {
                        this.value = " ";
                        this.setSelectionRange(0, 0);
                    }
                    else if (this.value.length == 2 && this.value[1] == " ") {
                        this.value = this.value.substring(0, 1);
                        this.setSelectionRange(1, 1);
                    }


                    activeObject.text = this.value;

                    canvas.renderAll();
                    // dfdf

                }
            });
        }


        $('#fontFamily').change(function () {
            var fontFamily = $(this).val();
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.fontFamily = (activeObject.fill == fontFamily ? '' : fontFamily);
                canvas.renderAll();
            }
        });

        $('.showPaletteOnly').change(function (e) {
            var fillColor = $(this).val();
            var activeObject = canvas.getActiveObject();
            if (canvas.getActiveObject() && (fillColor != activeObject.fill)) {
                if (fillColor == "#000" && activeObject.fill == "#000000") {
                    // alert("black match : " + fillColor);
                }
                else {
                    canvas.fire('object:modified', { target: canvas.getActiveObject() });
                    //alert("Color Change Fire (" + activeObject.fill + " " + fillColor + ") ");
                    activeObject.fill = fillColor;
                    activeObject.setOpacity(1);
                    activeObject.stroke = null;
                    canvas.renderAll();

                }
            }

        });

        $('#borderColor').change(function () {
//            canvas.fire('object:modified', { target: canvas.getActiveObject() });

            var strokeColor = $(this).val();

            borderSingle.stroke = strokeColor;
            borderDouble.stroke = strokeColor;
            borderScalloped.stroke = strokeColor;

            borderSingle.opacity = 1;
            borderDouble.opacity = 1;
            borderScalloped.opacity = 1;

            canvas.renderAll();
        });

        $('#textBold').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.fontWeight = (activeObject.fontWeight == 'bold' ? '' : 'bold');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textItalic').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.fontStyle = (activeObject.fontStyle == 'italic' ? '' : 'italic');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textUnderline').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textDecoration = (activeObject.textDecoration == 'underline' ? '' : 'underline');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textStrikethrough').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textDecoration = (activeObject.textDecoration == 'line-through' ? '' : 'line-through');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#alignLeft').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textAlign = 'left';
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#alignCenter').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textAlign = 'center';
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#alignRight').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textAlign = 'right';
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textEngraved, #shapeEngraved').click(function () {
            var activeObject = canvas.getActiveObject();

            if (activeObject) {

                activeObject.set({engraved: true});
                console.log(activeObject);

                if (activeObject.type == "path" || activeObject.type == "polygon" || activeObject.type == "rect" || activeObject.type == "circle" || activeObject.type == "ellipse" || activeObject.type == "triangle") {
                    activeObject.setColor("#000000");
                    activeObject.setOpacity("0.3");

//                    activeObject.setPatternFill({
//                        source: $("#engravedbg").attr("src")
//                    });

                    activeObject.set({ strokeWidth: (1 / activeObject.scaleX ), stroke: 'rgba(0,0,0,1)', strokeDashArray: [3 / activeObject.scaleX, 2 / activeObject.scaleX] });

                    canvas.renderAll();
                    canvas.fire('object:modified', { target: canvas.getActiveObject() });
                }

                // text decoration
                if (activeObject.type == "text") {
                    activeObject.fill = "#000000";
                    activeObject.opacity = "0.3";

                    console.log(canvas.item(0)._element.src);
                    // console.log(canvas.item(0).outerHTML());


//                    activeObject.setPatternFill({
//                        source: $("#engravedbg").attr("src")
//                    });

                    activeObject.set({ strokeWidth: (1 / activeObject.scaleX ), stroke: 'rgba(0,0,0,1)', strokeDashArray: [3 / activeObject.scaleX, 2 / activeObject.scaleX] });

                    canvas.renderAll();
                    canvas.fire('object:modified', { target: canvas.getActiveObject() });
                }
            }
        });

        $('#borderEngraved').click(function () {
//            canvas.fire('object:modified', { target: canvas.getActiveObject() });
            borderSingle.set({engraved: true}).setOpacity("0.3");
            borderDouble.set({engraved: true}).setOpacity("0.3");
            borderScalloped.set({engraved: true}).setOpacity("0.3");

            borderSingle.stroke = "#000000";
            borderDouble.stroke = "#000000";
            borderScalloped.stroke = "#000000";

            canvas.renderAll();
        });

        $('#flipX').click(function () {
            var activeObject = canvas.getActiveObject();
            activeObject.flipX = (activeObject.flipX != true);
            canvas.renderAll();
        });

        $('#flipY').click(function () {
            var activeObject = canvas.getActiveObject();
            activeObject.flipY = (activeObject.flipY != true);
            canvas.renderAll();
        });

        $('#bringForward').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.bringForward(activeObject);
            canvas.renderAll();
        });

        $('#bringToFront').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.bringToFront(activeObject);
            canvas.renderAll();
        });

        $('#sendBackwards').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.sendBackwards(activeObject);
            canvas.renderAll();
        });

        $('#sendToBack').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.sendToBack(activeObject).bringForward((activeObject));
            canvas.renderAll();
        });

        $('#deleteActiveObject').click(function () {
            var activeObject = canvas.getActiveObject(),
                    activeGroup = canvas.getActiveGroup();
            if (activeObject) {

                canvas.fire('object:removed', { target: canvas.getActiveObject() });
                canvas.remove(activeObject);
            }
            else if (activeGroup) {
                var objectsInGroup = activeGroup.getObjects();
                canvas.discardActiveGroup();
                objectsInGroup.forEach(function (object) {
                    canvas.fire('object:removed', { target: canvas.getActiveObject() });
                    canvas.remove(object);
                });
            }
        });

        $('#cloneActiveObject').click(function () {
            var activeObject = canvas.getActiveObject();
            var activeGroup = canvas.getActiveGroup();

            if (activeObject) {

                var clonedObject = activeObject.clone(function (clone) {
                    clone.set({ top: canvas.getActiveObject().get('top') + 10, left: canvas.getActiveObject().get('left') + 10, hasRotatingPoint: true });
                    canvas.add(clone);
                    canvas.setActiveObject(clone);
                    clone.set({
                        borderColor: 'cyan',
                        cornerColor: 'cyan'
                    });
                    canvas.renderAll();
                });
            }
            else if (activeGroup) {
                alert("group");
                var selection = activeGroup.getObjects();
                canvas.deactivateAll();
                var clones = [];
                selection.forEach(function (v, i) {
                    var clone = v.clone();
                    clone.set({ top: v.get('top') + 10,
                        left: v.get('left') + 10,
                        hasRotatingPoint: true,
                        borderColor: 'cyan',
                        cornerColor: 'cyan'
                    });
                    canvas.add(clone);
                    clone.setActive(true);
                    clones.push(clone);
                });
                var group = new fabric.Group(clones);
                canvas.setActiveGroup(group);
                group.saveCoords();
                canvas.renderAll();
            }
        });

        $('#shapeSelect').change(function () {
//            var svg = "";
//            $.ajax({
//                url: "/custom_sign/get_graphic_url_ajax",
//                data: { id: $(this).val() }
//            }).done(function(result){
//                svg = result.image_path;
//                alert(svg);
//                fabric.loadSVGFromURL(svg, function (objects, options) {
//                    var obj = fabric.util.groupSVGElements(objects, options);
//                    /*var ctx = canvas.getContext();
//                     ctx.shadowColor = "rgba(255,255,255,0.75)";
//                     ctx.shadowBlur = 0;
//                     ctx.shadowOffsetX = 0;
//                     ctx.shadowOffsetY = 1;*/
//                    canvas.add(obj.scale(canvasScale)).centerObject(obj).renderAll();
//                    obj.setCoords();
//                    obj.hasRotatingPoint = true;
//                    obj.set({
//                        borderColor:'cyan',
//                        cornerColor:'cyan'
//                    })
//                });
//            });


            var svg = "/assets/svg/" + $(this).val() + ".svg";

            // handel the uploads from admin
            if (!isNaN($(this).val().replace("id_", ""))) {
                svg = "/custom_sign/get_custom_shape_svg/" + $(this).val().toLowerCase().replace("id_", "") + ".svg"
            }


            fabric.loadSVGFromURL(svg, function (objects, options) {
                var obj = fabric.util.groupSVGElements(objects, options);
                /*var ctx = canvas.getContext();
                 ctx.shadowColor = "rgba(255,255,255,0.75)";
                 ctx.shadowBlur = 0;
                 ctx.shadowOffsetX = 0;
                 ctx.shadowOffsetY = 1;*/
                // set the position
                obj.set('left', canvas.getCenter().left);
                obj.set('top', canvas.getCenter().top);

                obj.scale(canvasScale);

                obj.setCoords();
                obj.fill = "#000000"
                obj.hasRotatingPoint = true;
                obj.set({
                    borderColor: 'cyan',
                    cornerColor: 'cyan'
                });

                captureCurrentState();

                canvas.add(obj);

                canvas.setActiveObject(obj);
                canvas.renderAll();

                // call modified

                // canvas.fire('object:modified', { target: obj });

            });
        });

        var borderInset = 50, scallopDepth = 70, borderX = canvasWidth - borderInset, borderY = canvasHeight - borderInset, scallopX = canvasWidth - scallopDepth, scallopY = canvasHeight - scallopDepth;

        var borderSingle = new fabric.Path([
            ['M', borderInset, borderInset],
            ['V', borderY],
            ['H', borderX],
            ['V', borderInset],
            ['H', borderInset]
        ], {
            fill: '',
            height: canvasHeight,
            selectable: false,
            stroke: 'black',
            width: canvasWidth
        });

        var borderDouble = new fabric.Path([
            ['M', borderInset, borderInset],
            ['V', borderY],
            ['H', borderX],
            ['V', borderInset],
            ['H', borderInset],
            ['M', scallopDepth, scallopDepth],
            ['V', canvasHeight - scallopDepth],
            ['H', canvasWidth - scallopDepth],
            ['V', scallopDepth],
            ['H', scallopDepth]
        ], {
            fill: '',
            height: canvasHeight,
            selectable: false,
            stroke: 'black',
            width: canvasWidth
        });

        var borderScalloped = new fabric.Path([
            ['M', scallopDepth, borderInset],
            ['Q', scallopDepth, scallopDepth, borderInset, scallopDepth],
            ['V', scallopY],
            ['Q', scallopDepth, scallopY, scallopDepth, canvasHeight - borderInset],
            ['H', scallopX],
            ['Q', scallopX, scallopY, canvasWidth - borderInset, scallopY],
            ['V', scallopDepth],
            ['Q', scallopX, scallopDepth, scallopX, borderInset],
            ['H', scallopDepth]
        ], {
            fill: '',
            height: canvasHeight,
            selectable: false,
            stroke: 'black',
            width: canvasWidth
        });

        $('#borderSelect').change(function () {
            var borderSelect = $('#borderSelect option:selected').val();

            if (borderSelect == "noborder") {
                ignor_last_action = true;
                canvas.remove(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderDouble);
                ignor_last_action = true;
                canvas.remove(borderScalloped);
            }

            else if (borderSelect == "single") {
                ignor_last_action = true;
                canvas.add(borderSingle.scale(canvasScale)).centerObject(borderSingle).sendToBack(borderSingle).bringForward(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderDouble);
                ignor_last_action = true;
                canvas.remove(borderScalloped);
            }
            else if (borderSelect == "double") {
                ignor_last_action = true;
                canvas.add(borderDouble.scale(canvasScale)).centerObject(borderDouble).sendToBack(borderDouble).bringForward(borderDouble);
                ignor_last_action = true;
                canvas.remove(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderScalloped);
            }
            else if (borderSelect == "scalloped") {
                ignor_last_action = true;
                canvas.add(borderScalloped.scale(canvasScale)).centerObject(borderScalloped).sendToBack(borderScalloped).bringForward(borderScalloped);
                ignor_last_action = true;
                canvas.remove(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderDouble);
            }
        });

        $("#borderThicknessSlider").slider({
            value: 1,
            min: 1,
            max: 10,
            step: 1,
            slide: function (event, ui) {
                borderSingle.set({
                    strokeWidth: ui.value
                });
                borderDouble.set({
                    strokeWidth: ui.value
                });
                borderScalloped.set({
                    strokeWidth: ui.value
                });

                if (borderSingle.get("engraved")) {
                    borderSingle.opacity = 0.3;
                    borderDouble.opacity = 0.3;
                    borderScalloped.opacity = 0.3;
                }
                else {
                    borderSingle.opacity = 1;
                    borderDouble.opacity = 1;
                    borderScalloped.opacity = 1;
                }

                canvas.renderAll();
            }
        });
        <% if @sign_data.based_on.nil? %>
        $('#clearCanvas').click(function () {
            if (confirm('Are you sure?')) {
                var toRemove = [];
                $.each(canvas.getObjects(), function (i, e) {
                    if (e.selectable) {
                        toRemove.push(e);
                    }
                });

                while (toRemove.length > 0) {
                    canvas.remove(toRemove.pop());
                }
            }


            $(disabledTools).addClass('disabled');
        });

        $('#startagain').click(function () {
            if (confirm('Are you sure?')) {
                var toRemove = [];
                $.each(canvas.getObjects(), function (i, e) {
                    if (e.selectable) {
                        toRemove.push(e);
                    }
                });

                while (toRemove.length > 0) {
                    canvas.remove(toRemove.pop());
                }
            }

            $(disabledTools).addClass('disabled');
        });


        <% else %>
        $('#clearCanvas').click(function () {
            if (confirm('Are you sure?')) {
                canvas.clear();
                $.ajax({
                    url: "/custom_sign/reset_sign_data_ajax",
                    data: { id: <%= @sign_data.based_on.to_s %> }
                }).done(function (result) {
                            $("#sign_data").val(result.sign_data);
                            var jsn = $.base64.decode($("#sign_data").val());
                            canvas.loadFromJSON(jsn);
                        });
            }
            $(disabledTools).addClass('disabled');
        });
        <% end %>

        var in_by = 35;


        //Top Left Screw Hole
        var topLeftScrewHole = new fabric.Circle({
            left: in_by,
            top: in_by,
            radius: 10,
            selectable: false
        });

        topLeftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        //Top Left Screw Hole
        var topScrewHole = new fabric.Circle({
            left: canvasWidth / 2,
            top: in_by,
            radius: 10,
            selectable: false
        });

        topScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var topRightScrewHole = new fabric.Circle({
            left: canvasWidth - in_by,
            top: in_by,
            radius: 10,
            selectable: false
        });

        topRightScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var rightScrewHole = new fabric.Circle({
            left: canvasWidth - in_by,
            top: canvasHeight / 2,
            radius: 10,
            selectable: false
        });

        rightScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var leftScrewHole = new fabric.Circle({
            left: in_by,
            top: canvasHeight / 2,
            radius: 10,
            selectable: false
        });

        leftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var bottomRightScrewHole = new fabric.Circle({
            left: canvasWidth - in_by,
            top: canvasHeight - in_by,
            radius: 10,
            selectable: false
        });

        bottomRightScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: bottomRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var bottomLeftScrewHole = new fabric.Circle({
            left: in_by,
            top: canvasHeight - in_by,
            radius: 10,
            selectable: false
        });

        bottomLeftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: bottomLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var bottomScrewHole = new fabric.Circle({
            left: canvasWidth / 2,
            top: canvasHeight - in_by,
            radius: 10,
            selectable: false
        });

        bottomLeftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: bottomLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });


        var outerScrewHoleTL = new fabric.Circle({
            left: -20,
            top: -20,
            radius: 10,
            selectable: false
        });

        var outerScrewHoleTR = new fabric.Circle({
            left: canvasWidth + 20,
            top: -20,
            radius: 10,
            selectable: false
        });

        var outerScrewHoleBL = new fabric.Circle({
            left: -20,
            top: canvasHeight + 20,
            radius: 10,
            selectable: false
        });

        var outerScrewHoleBR = new fabric.Circle({
            left: canvasWidth + 20,
            top: canvasHeight + 20,
            radius: 10,
            selectable: false
        });


        var screwholesarray = [];

        <% if @sign_data.get_base_shape().screw_hole_bottom_left %>
        screwholesarray.push(bottomLeftScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_bottom %>
        screwholesarray.push(bottomScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_bottom_right %>
        screwholesarray.push(bottomRightScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_left %>
        screwholesarray.push(leftScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_right %>
        screwholesarray.push(rightScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_top_left %>
        screwholesarray.push(topLeftScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_top %>
        screwholesarray.push(topScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_top_right %>
        screwholesarray.push(topRightScrewHole);
        <% end %>

        // add screwhomes to llow centering to occur correctly
        screwholesarray.push(outerScrewHoleBL);
        screwholesarray.push(outerScrewHoleBR);
        screwholesarray.push(outerScrewHoleTL);
        screwholesarray.push(outerScrewHoleTR);

        var screwHoles = new fabric.Group(screwholesarray, {selectable: false});
        $('#toggleScrewHoles').toggle(function () {
            ignor_last_action = true;
            canvas.add(screwHoles.scale(canvasScale)).centerObject(screwHoles);
            $(this).addClass("active");
        }, function () {
            ignor_last_action = true;
            canvas.remove(screwHoles);
            $(this).removeClass("active");
        });

        var leftMargin = new fabric.Line([40, 0, 40, canvasHeight], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });
        var topMargin = new fabric.Line([0, 40, canvasWidth, 40], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });
        var rightMargin = new fabric.Line([canvasWidth - 40, 0, canvasWidth - 40, canvasHeight], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });
        var bottomMargin = new fabric.Line([0, canvasHeight - 40, canvasWidth, canvasHeight - 40], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });

        var margins = new fabric.Group([leftMargin, topMargin, rightMargin, bottomMargin], {selectable: false});

        $('#toggleMargins').toggle(function () {
            // margins.scale(canvasScale);

            ignor_last_action = true;
            canvas.add(margins);
            ignor_last_action = true;
            canvas.centerObject(margins);
            ignor_last_action = true;
            canvas.sendToBack(margins);
            ignor_last_action = true;
            canvas.bringForward(margins);

            $(this).addClass("active");
        }, function () {
            ignor_last_action = true;
            canvas.remove(margins);
            $(this).removeClass("active");
        });


        $('#zoomIn').click(function () {
            if (canvasScale < 3.375) {
                canvasScale = canvasScale * 1.5;
                canvas.setHeight(canvas.getHeight() * 1.5);
                canvas.setWidth(canvas.getWidth() * 1.5);
                var obj = canvas.getObjects();
                for (var i in obj) {
                    var scaleX = obj[i].get('scaleX');
                    var scaleY = obj[i].get('scaleY');
                    var left = obj[i].get('left');
                    var top = obj[i].get('top');

                    var tempScaleX = scaleX * 1.5;
                    var tempScaleY = scaleY * 1.5;
                    var tempLeft = left * 1.5;
                    var tempTop = top * 1.5;

                    obj[i].set('scaleX', tempScaleX);
                    obj[i].set('scaleY', tempScaleY);
                    obj[i].set('left', tempLeft);
                    obj[i].set('top', tempTop);

                    obj[i].setCoords();
                }
            }
            applyMask();
            canvas.renderAll();
            canvas.calcOffset();
            $('#canvasScale').text(Math.round(canvasScale * 100) + "%");
            canvasMargin = $('.canvas-container').css("margin-left");
            $('#toolPalette').css('right', (parseInt(canvasMargin, 10) - 93) + 'px');

        });

        $('#zoomOut').click(function () {
            if (canvasScale > 0.3) {
                canvasScale = canvasScale / 1.5;
                canvas.setHeight(canvas.getHeight() / 1.5);
                canvas.setWidth(canvas.getWidth() / 1.5);
                var obj = canvas.getObjects();
                for (var i in obj) {
                    var scaleX = obj[i].get('scaleX');
                    var scaleY = obj[i].get('scaleY');
                    var left = obj[i].get('left');
                    var top = obj[i].get('top');

                    var tempScaleX = scaleX / 1.5;
                    var tempScaleY = scaleY / 1.5;
                    var tempLeft = left / 1.5;
                    var tempTop = top / 1.5;

                    obj[i].set('scaleX', tempScaleX);
                    obj[i].set('scaleY', tempScaleY);
                    obj[i].set('left', tempLeft);
                    obj[i].set('top', tempTop);

                    obj[i].setCoords();
                }
            }
            applyMask();
            canvas.renderAll();

            $('#canvasScale').text(Math.round(canvasScale * 100) + "%");

            canvasMargin = $('.canvas-container').css("margin-left");
            $('#toolPalette').css('right', (parseInt(canvasMargin, 10) - 93) + 'px');
        });

        var disabledTools = $('#deleteActiveObject, #cloneActiveObject, #bringForward, #sendBackwards, #flipY, #flipX');

        canvas.observe('object:selected', function () {
            var activeObject = canvas.getActiveObject();
            $(disabledTools).removeClass('disabled');
            if (activeObject && activeObject.type === 'text') {
                $('#addTextMenu').show();
                $('#addShapeMenu').hide();
                $('#addBorderMenu').hide();
            }
            if (activeObject && activeObject.type === 'path') {
                $('#addShapeMenu').show();
                $('#addTextMenu').hide();
                $('#addBorderMenu').hide();
            }
        });

        canvas.observe('object:scaling', function () {
            var engraved = false;

            var activeObject = canvas.getActiveObject();

            if (activeObject.get("engraved")) {
                engraved = true;
            }


            // style fill and stroke up
            if (engraved) {
                activeObject.set({ strokeWidth: (1 / activeObject.scaleX ), stroke: 'rgba(0,0,0,1)', strokeDashArray: [3 / activeObject.scaleX, 2 / activeObject.scaleX]});
                console.log("object scaling : " + engraved);
            }
        });

        canvas.observe('selection:created', function () {
            $(disabledTools).removeClass('disabled');
        });

        canvas.observe('selection:cleared', function () {
            $(disabledTools).addClass('disabled');
        });

        <% if !params["id"].nil? %>
        //jQuery.ajax("/custom_sign/load_sign_ajax?saved_sign_id=" +
        <%=params["id"]%>)
        ;
        $("#sign_data").val('<%= @sign_data.sign_data %>');
        alert($("#sign_data").val());
        var jsn = $.base64.decode($("#sign_data").val());
        canvas.loadFromJSON(jsn);
        <% end %>

    })
            ();

    function SetupCanvasEventHooks(canvas) {


        canvas.observe('object:modified', function () {
            console.log("object:modified");
            if (canvas_track_changes && !ignor_last_action) {
                redoStack = [];
                appendToUndoStack();
                captureCurrentState();
            }
            else {
                ignor_last_action = false;
            }
        });

        canvas.observe('object:added', function () {
            console.log("object:added : " + canvas_track_changes + " " + !ignor_last_action);
            if (canvas_track_changes && !ignor_last_action) {

                redoStack = [];
                appendToUndoStack();
                captureCurrentState();
            }
            else {
                ignor_last_action = false;
            }
        });

        canvas.observe('object:removed', function () {
            console.log("object:removed");
            if (canvas_track_changes && !ignor_last_action) {
                redoStack = [];
                appendToUndoStack();
                captureCurrentState();
            }
            else {
                ignor_last_action = false;
            }
        });

        function CustomLoadFromHistory(prevObj) {
            var toRemove = [];

            $.each(canvas.getObjects(), function (i, e) {
                if (e.selectable || e.type != "image") {
                    toRemove.push(e);
                }
            });

            while (toRemove.length > 0) {
                ignor_last_action = true;
                canvas.remove(toRemove.pop());
            }

            $.each(prevObj, function (i, e) {
                if (e.selectable || e.type != "image") {
                    ignor_last_action = true;
                    canvas.add(e); // add object
                }
            });

            canvas.renderAll();

            ignor_last_action = false;
        }


        $('#undo').click(function undo() {
            if (undoStack.length == 0) {
                alert("nothing to un-do!")
            }
            else {

                captureCurrentState();
                appendToRedoStack();
                CustomLoadFromHistory(undoStack.pop());
            }
        });

        $('#redo').click(function redo() {

            if (redoStack.length == 0) {
                alert("nothing to re-do!")
            }
            else {
                captureCurrentState();
                appendToUndoStack();
                CustomLoadFromHistory(redoStack.pop());
            }
        });

        canvas_track_changes = true;
    }

    function appendToUndoStack() {
        console.log("Adding to undo stack, size : " + undoStack.length.toString());
        undoStack.push(currentState);
    }

    function appendToRedoStack() {
        console.log("Adding to redo stack, size : " + redoStack.length.toString());
        redoStack.push(currentState);
    }

    function captureCurrentState() {
        // reset the redo stack
        var hist = [];

        $.each(canvas.getObjects(), function (i, e) {
            if (e.selectable || e.type != "image") {
                hist.push(jQuery.extend(true, {}, e));
            }
        });

        currentState = hist;
    }

    function applyMask() {
        if (mask_svg_url != "") {
            var tempContext = canvas.getContext("2d");

            fabric.loadSVGFromURL(mask_svg_url, function (objects, options) {
                var mask = fabric.util.groupSVGElements(objects, options);

                mask.scaleX = canvas.width / mask.width;
                mask.scaleY = canvas.height / mask.height;
                mask.top = canvas.height / 2;
                mask.left = canvas.width / 2;
                canvas.clipTo = (function (ctx) {
                    mask.render(ctx);
                });

                canvas.renderAll();

            });
        }
    }
</script>