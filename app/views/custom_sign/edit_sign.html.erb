<% content_for :stylesheets do %>
    <%= stylesheet_link_tag('select2', 'spectrum', 'customisation', 'stylesheet', 'jquery-fancybox', 'jquery.qtip', 'joyride-1.0.5') %>
<% end %>

<% content_for :javascripts do %>
    <%= javascript_include_tag('select2.min', 'spectrum', 'customisation', 'fabric', 'jquery-base64-min', 'jquery-fancybox-pack', 'jquery-ui-1.8.23.custom.min', 'jquery.qtip.min', 'modernizr.mq', 'jquery.joyride-2.1') %>
<% end %>

<div id="loadingOverlay"></div>
<div id="tourOverlay"></div>
<div id="canvasZoomWrapper">
  <div class="minorFunctions" id="minorFunctions">
    <div class="function" id="startagain">Start Again</div>
    <div class="function" id="clearCanvas">Clear Canvas</div>
    <div class="function" id="startTutorial">Quick Tutorial</div>
    <% if current_refinery_user %>
        <div class="function" id="saveCanvas">Save</div>
        <div class="function" id="loadCanvas">Load</div>
    <% end %>
  </div>
  <div style="position: absolute; top: 90px; color: white; left: 50px; display: none;">Canvas Size : Width
    : <%= (params[:width].to_f)/10 %>cm X Height : <%= (params[:height].to_f)/10 %>cm
  </div>

  <canvas style="z-index: 10;" id="my-canvas" width="600" height="600"></canvas>


  <!--Object buttons-->
  <div class="majorFunctions" id="majorFunctions">

    <!--Add Text-->
    <div class="buttonContainer">
      <div class="button addText" id="addText">Add Text</div>
      <div class="menu addTextMenu" id="addTextMenu">
        <div class="arrow"></div>
        <div class="function textBold" id="textBold" title="Bold"></div>
        <div class="function textItalic" id="textItalic" title="Italic"></div>
        <div class="function textUnderline" id="textUnderline" title="Underline"></div>
        <div class="function textStrikethrough" id="textStrikethrough" title="Strikethrough"></div>
        <div class="function alignLeft" id="alignLeft" title="Left Align"></div>
        <div class="function alignCenter" id="alignCenter" title="Centre Align"></div>
        <div class="function alignRight" id="alignRight" title="Right Align"></div>
        <select class="fontFamily" id="fontFamily">
          <optgroup label="Serif">
            <option value="ArvoRegular">Arvo</option>
            <option value="DroidSerifRegular">Droid Serif</option>
            <option value="RokkittRegular">Rokkitt</option>
          </optgroup>
          <optgroup label="Sans Serif">
            <option value="OpenSansRegular" selected="selected">Open Sans</option>
            <option value="OswaldRegular">Oswald</option>
            <option value="QuestrialRegular">Questrial</option>
          </optgroup>
          <optgroup label="Display">
            <option value="ChewyRegular">Chewy</option>
            <option value="FredokaOneRegular">Fredoka One</option>
            <option value="SpecialEliteRegular">Special Elite</option>
          </optgroup>
          <optgroup label="Handwriting">
            <option value="ComingSoonRegular">Coming Soon</option>
            <option value="PacificoRegular">Pacifico</option>
            <option value="PermanentMarkerRegular">Permanent Marker</option>
          </optgroup>
        </select>
        <input type="text" class="showPaletteOnly" value="#000000" id="textColor"/>

        <div class="function engraved" id="textEngraved">
          <span>Engraved, no paint</span>
        </div>
      </div>
    </div>

    <!--Add Shape-->
    <div class="buttonContainer">
      <div class="button addShape" id="addShape">Add Shape</div>
      <div class="menu addShapeMenu" id="addShapeMenu">
        <div class="arrow"></div>
        <select class="shapeSelect" id="shapeSelect">
          <option></option>
          <% get_sign_graphic_category.each do |cat| %>
              <optgroup label="<%= cat.category_name %>">
                <% get_sign_graphics_for_category(cat.id).each do |g| %>
                    <option value="id_<%= g.id %>"><%= g.title %></option>
                <% end %>
              </optgroup>
          <% end %>
          <optgroup label="Animals">
            <option value="ant">Ant</option>
            <option value="bear">Bear</option>
            <option value="chicken">Chicken</option>
            <option value="cow">Cow</option>
            <option value="crab">Crab</option>
            <option value="crow">Crow</option>
            <option value="deadbird">Dead Bird</option>
            <option value="seahorse">Seahorse</option>
            <option value="squirrel">Squirrel</option>
          </optgroup>
        </select>
        <input type="text" class="showPaletteOnly" value="#000000" id="shapeColor"/>

        <div class="function engraved" id="shapeEngraved">
          <span>Engraved, no paint</span>
        </div>
      </div>
    </div>

    <!--Add Border-->
    <div class="buttonContainer">
      <div class="button addBorder" id="addBorder">Add Border</div>
      <div class="menu addBorderMenu" id="addBorderMenu">
        <div class="arrow"></div>
        <select class="borderSelect" id="borderSelect">
          <option></option>
          <option value="noborder">No Border</option>
          <option value="single">Single</option>
          <option value="double">Double</option>
          <option value="scalloped">Scalloped</option>
        </select>
        <label>Border thickness:</label>

        <div id="borderThicknessSlider"></div>
        <input type="text" class="showPaletteOnly" id="borderColor" value="#000000"/>

        <div class="function engraved" id="borderEngraved">
          <span>Engraved, no paint</span>
        </div>
      </div>
    </div>

    <!--Price-->
    <div class="priceWrapper">
      <span class="price">&pound;<%= number_with_precision(@sign_data.price, :precision => 2) %></span><span class="inclVAT"> Incl. VAT</span>
    </div>

    <!--Add to Basket button-->
    <div class="addToBasket" id="addToBasket">Add to Basket</div>
  </div>

  <!--Tool palette-->
  <div class="toolPalette" id="toolPalette">
    <div class="grabHandle" id="grabHandle"></div>
    <div class="label">
      Undo/Redo
    </div>
    <div class="toolRow">
      <div class="tool" id="undo" title="Undo"></div>
      <div class="tool" id="redo" title="Redo"></div>
    </div>
    <div class="label">
      Delete/Clone
    </div>
    <div class="toolRow">
      <div class="tool disabled" id="deleteActiveObject" title="Delete"></div>
      <div class="tool disabled" id="cloneActiveObject" title="Clone"></div>
    </div>
    <div class="label">
      Zoom = <span id="canvasScale">100%</span>
    </div>
    <div class="toolRow">
      <div class="tool" id="zoomIn" title="Zoom In"></div>
      <div class="tool" id="zoomOut" title="Zoom Out"></div>
    </div>
    <div class="label">
      Arrange
    </div>
    <div class="toolRow">
      <div class="tool disabled" id="bringForward" title="Bring Forward"></div>
      <div class="tool disabled" id="sendBackwards" title="Send Backwards"></div>
    </div>
    <div class="label">
      Flip Object
    </div>
    <div class="toolRow">
      <div class="tool disabled" id="flipY" title="Flip Vertical"></div>
      <div class="tool disabled" id="flipX" title="Flip Horizontal"></div>
    </div>
    <div class="label">
      Guides
    </div>
    <div class="toolRow">
      <div class="tool" id="toggleScrewHoles" title="Show Screw Holes"></div>
      <div class="tool" id="toggleMargins" title="Show Margins"></div>
    </div>
  </div>
</div>
<div id="hiddenForm">
  <form action="/custom_sign/save_dialog" method="POST" id="customSignForm">
    <input type="hidden" id="sign_data" name="sign_data" value="">
    <input type="hidden" id="svg_data" name="svg_data" value="">
    <input type="hidden" id="sign_data_id" name="sign_data_id" value="<%= @sign_data.id %>">
    <input type="hidden" id="account_id" name="account_id" value="<%= current_refinery_user ? current_refinery_user.id : '' %>">
    <input type="hidden" id="product_id" name="product_id" value="<%= @sign_data.spree_product_id %>">
    <input type="hidden" id="quantity" name="quantity" value="1">
    <input type="hidden" id="base64png" name="base64png" value="">
    <input type="hidden" id="name" name="name" value="">
    <input type="hidden" id="description" name="description" value="">
    <input type="hidden" id="calculated_price" name="calculated_price" value="<%= @sign_data.price %>">
  </form>
</div>
<div id="savingOverlay"></div>
<ol id="tourSteps">
  <li data-id="addText" data-text="Next - Create a shape"><h4>Add Text <span>(1 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
  <li data-id="addShape" data-text="Next - Add a Border"><h4>Add Shape <span>(2 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
  <li data-id="addBorder" data-text="Next - Add to Basket"><h4>Add Border <span>(3 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
  <li data-id="addToBasket" data-text="Finish Tour"><h4>Add to Basket <span>(4 of 4)</span></h4>

    <p>Click here to add text to your sign.</p>

    <p><strong>Tip: </strong>If you want to edit some existing text, select it and use the tools that will appear here
      to change it's attributes.</p></li>
</ol>
<div style="display: none;">
  <img id="engravedbg" src="/assets/engraved_bg.png">
</div>
<script src="/assets/aligning_guidelines"></script>
<script src="/assets/centering_guidelines"></script>

<pre><%= params.to_yaml %></pre>
<script>

    var undoStack = [];
    var redoStack = [];
    var currentState = [];
    var canvas_track_changes = false;
    var ignor_last_action = true;
    var mask_svg_url = '';
    var canvasMargin = $('.canvas-container').css("margin-left");
    var base64png = "";
    var canvasWidth = ($(window).width() - 200);
    var canvasHeight = ($(window).height() - 300);
    var screwholesarray = [];
    var canvasScale = 1.0;
    var placeholderText = 'Double click to change me...';

    var borderSingle = null;
    var borderDouble = null;
    var borderScalloped = null;

    var canvas = null;
    var mask_object = null;
    // added to fix de-authentication when posting ajax : Doug

    var textUpdateOnce = null;

    function canvasUpdate() {
        canvas.renderAll();
        cancelTextRefreshTimer()
    }

    function cancelTextRefreshTimer() {
        clearInterval(textUpdateOnce);
    }

    (function () {
        SetupAll();
    })
            ();

    function SetupAll() {
        $("#redo").addClass('disabled');
        $("#undo").addClass('disabled');

        $("#savingOverlay").hide();


        canvas = new fabric.Canvas('my-canvas');

        initAligningGuidelines(canvas);
        initCenteringGuidelines(canvas);

        // Update the two variables below with usable area size

        var SignWidth = 100;
        SignWidth = <%= @sign_data.width %>;
        var SignHeight = 100;
        SignHeight = <%= @sign_data.height %>;
        // alert(SignHeight);

        // track the change activity on canvas


        if (SignWidth / canvasWidth > SignHeight / canvasHeight) {
            canvasHeight = (canvasWidth / SignWidth) * SignHeight;
        }
        else {
            canvasWidth = (canvasHeight / SignHeight) * SignWidth;
        }


        canvas.setWidth(canvasWidth);
        canvas.setHeight(canvasHeight);

        // alert(canvasWidth);
        // alert(canvasHeight);

        // canvas.backgroundImageStretch = true;

        addBackingImage();
        addMask();


        $('#toolPalette').css('right', (parseInt(canvasMargin, 10) - 30) + 'px');

        // setup slider beore loading sign (since it may have a border
        $("#borderThicknessSlider").slider({
            value: 1,
            min: 1,
            max: 10,
            step: 1,
            slide: function (event, ui) {
                borderSingle.set({
                    strokeWidth: ui.value
                });
                borderDouble.set({
                    strokeWidth: ui.value
                });
                borderScalloped.set({
                    strokeWidth: ui.value
                });

                if (borderSingle.get("engraved") == true) {
                    borderSingle.opacity = 0.3;
                    borderDouble.opacity = 0.3;
                    borderScalloped.opacity = 0.3;
                }
                else {
                    borderSingle.opacity = 1;
                    borderDouble.opacity = 1;
                    borderScalloped.opacity = 1;
                }

                canvas.renderAll();
            },
            stop: function () {
                canvas.renderAll();

                ignor_last_action = false;
                canvas.fire('object:modified', { target: borderSingle });
            }
        });


        // loads sign if applicable
        reloadSign();

        // set the mask for the sign


        //canvas.renderAll();

        // setup complete

        SetupCanvasEventHooks(canvas);

        //canvas.clear();

        $('<textarea rows="1" cols="1" id="textArea"></textarea>').appendTo('.canvas-container');


        $("#addToBasket").click(function () {
            // serialize the custom sign data
            // add this to the form field
            // var json = JSON.stringify(canvas);
            // alert(json);

            // alert(svg_data);
            var custom_data = $.base64.encode(getCanvasJSONCustom());
            $("#sign_data").val(custom_data);
            updateSVGfield();

            var id = $("#sign_data_id").val();
            var account_id = $("#account_id").val();
            var name = $("#name").val();
            var description = $("#description").val();
            var calculated_price = $("#calculated_price").val();

            var post_data = {
                authenticity_token: $("meta[name='csrf-token']").attr("content"),
                id: id,
                sign_data: custom_data,
                base64png: GetBase64PNG(),
                svg_data: $("#svg_data").val(),
                account_id: account_id,
                name: name,
                description: description,
                calculated_price: calculated_price
            };

            // about to save sign : this may take a few moments
            // add an overlay here / show state as saving
            $("#savingOverlay").show();
            $.ajax({
                type: "POST",
                url: "/custom_sign/save_sign",
                data: post_data
            }).done(function (msg) {

                        $("#customSignForm").prepend("<input type='hidden' name='authenticity_token' value='" + $("meta[name='csrf-token']").attr("content") + "'>")
                                .attr("action", "/orders/populate").submit();
                        // submit the form to the basket
                        $("#customSignForm").submit();
                        // remove saving state
                        // $("#savingOverlay").hide();
                    }
            ).fail(function () {
                        $("#savingOverlay").hide();
                        alert("There was an error saving");
                    }
            );
            // change submit path of the form
            // $("#customSignForm").attr("action", "/orders/populate");
            // submit the form to the basket
            // $("#customSignForm").submit();
        });

        $("#saveCanvas").click(function () {

            $("#sign_data").val($.base64.encode(getCanvasJSONCustom()));
            updateSVGfield();
            $("#base64png").val(GetBase64PNG());
            //this is where custom_sign/save_sign is called
            $.fancybox.open({href: '/custom_sign/save_dialog',
                title: 'Save Custom Sign',
                type: 'iframe',
                autoSize: 'false',
                width: '40%',
                height: '40%'
            });
            //$.fancybox.open( {href : '/assets/feature-image-1.jpg', title : 'Save Custom Sign', type : 'iframe', width : '640px', height : '480px'} );
            //jQuery.ajax("/custom_sign/save_sign?custom_data=" + $.base64.encode(json));
        });

//        $("#loadCanvas").click(function () {
//            //canvas.loadFromJSON(json);
//            $.fancybox.open({href: '/custom_sign/load_sign_list/
        <%#= session[:account_id].nil? ? "0" : session[:account_id].id.to_s %> //',
//                title: 'Save Custom Sign',
//                type: 'iframe',
//                autoSize: 'false',
//                minWidth: '640px',
//                minHeight: '480px',
//                maxWidth: '640px',
//                maxHeight: '480px',
//                width: '640px',
//                height: '480px'});
//        });


        canvas._onMouseUp = (function () {
            var activeObject = canvas.getActiveObject();
            return function (e) {
                canvas.__onMouseUp(e);
//                if (activeObject && activeObject.type === 'text') {
//                    var currentText = activeObject.getText();
//                    if (currentText = "") {
//                        currentText = " ";
//                    }
//
//                    canvas.fire('object:mouseup', { target: activeObject }, e);
//                    $('#textArea').focus().val(currentText);
//                    if (currentText == placeholderText) {
//                        $('#textArea').val('');
//                    }
//                }
            };

        })(canvas.setActiveObject);

        function dblClickHandler() {
            var activeObject = canvas.getActiveObject();

            if (canvas.getActiveObject() && canvas.getActiveObject().type === 'text') {

                console.log("vertical pos: " + (parseInt(activeObject.top) + parseInt(activeObject.height / 2)));
                console.log("canvas height: " + (parseInt(canvas.height)));

                var activeObjectFontFamily = canvas.getActiveObject().fontFamily;
                $('#fontFamily').val(activeObjectFontFamily).trigger("change");
                $('#textArea').val(activeObject.text);


                // console.log('-webkit-transform : rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')');

                console.log("double click text object");

                if (IsFireFox()) {
                    $('#textArea').css({
                        display: 'block',
                        left: activeObject.left - (activeObject.width * activeObject.scaleX) / 2,
                        //top: activeObject.top + activeObject.height / 2 + 10,
                        width: activeObject.width * activeObject.scaleX,
                        height: (activeObject.text.split("\n").length + 1) * 12,
                        zIndex: 100,
                        backgroundColor: "#ffffff",
                        padding: 5,
                        textAlign: activeObject.textAlign,
                        textDecoration: activeObject.textDecoration
                    }).focus();

                    if (parseInt(activeObject.top) + parseInt(activeObject.height * activeObject.scaleX / 2) > parseInt(canvas.height / 2)) {
                        $('#textArea').css({
                            top: parseInt(activeObject.top) - parseInt(activeObject.height * activeObject.scaleX / 2) - 20 - $('#textArea').height()
                        });
                    }
                    else {
                        $('#textArea').css({
                            top: parseInt(activeObject.top) + parseInt(activeObject.height * activeObject.scaleX / 2) + 10
                        });
                    }
                }
                else {

                    $('#textArea').css({
                        '-webkit-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                        '-moz-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                        '-0-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                        '-ms-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                        display: 'block',
                        fontFamily: activeObject.fontFamily,
                        fontSize: activeObject.fontSize,
                        height: activeObject.height,
                        left: activeObject.left - (activeObject.width) / 2,
                        lineHeight: activeObject.lineHeight,
                        textAlign: activeObject.textAlign,
                        top: activeObject.top - activeObject.height / 2,
                        width: activeObject.width,
                        zIndex: 100
                    });
                    $('#textArea').focus();
                    $('#textArea')[0].setSelectionRange($('#textArea').val().length - 1, $('#textArea').val().length - 1);


                }

                canvas.observe('object:modified', function () {
                    if (IsFireFox()) {

                        console.log("vertical pos: " + (parseInt(activeObject.top) + parseInt(activeObject.height / 2)));
                        console.log("canvas height: " + (parseInt(canvas.height)));

                        $('#textArea').css({
                            '-webkit-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                            height: ($("#textArea").val().split("\n").length + 1) * 12,
                            left: activeObject.left - (activeObject.width * activeObject.scaleX) / 2,
                            width: activeObject.width * activeObject.scaleX,
                            textAlign: activeObject.textAlign,
                            textDecoration: activeObject.textDecoration
                        });

                        // CHECK IF THE TEXT OBJECT IS GREATER THAN 50% below top
                        if (parseInt(activeObject.top) + parseInt(activeObject.height * activeObject.scaleX / 2) > parseInt(canvas.height / 2)) {
                            $('#textArea').css({
                                top: parseInt(activeObject.top) - parseInt(activeObject.height * activeObject.scaleX / 2) - 20 - $('#textArea').height()
                            });
                        }
                        else {
                            $('#textArea').css({
                                top: parseInt(activeObject.top) + parseInt(activeObject.height * activeObject.scaleX / 2) + 10
                            });
                        }
                    }
                    else {

                        $('#textArea').css({
                            '-webkit-transform': 'rotate(' + activeObject.get('angle') + 'deg) scale(' + activeObject.scaleX + ',' + activeObject.scaleY + ')',
                            height: activeObject.height,
                            left: activeObject.left - (activeObject.width / 2),
                            top: activeObject.top - activeObject.height / 2,
                            width: activeObject.width
                        });
                    }

                });
                canvas.observe('object:moving', function () {
                    $('#textArea').css({
                        display: 'none'
                    });
                    console.log("textarea display none");
                });
                canvas.observe('object:scaling', function () {
                    $('#textArea').css({
                        display: 'none'
                    });
                });
                canvas.observe('object:rotating', function () {
                    $('#textArea').css({
                        display: 'none'
                    });
                });
                canvas.observe('after:render', function () {
                    if (IsFireFox()) {
                        $('#textArea').css({
                            height: (activeObject.text.split("\n").length + 1) * 12,
                            left: activeObject.left - (activeObject.width * activeObject.scaleX) / 2,
                            textAlign: activeObject.textAlign,
                            textDecoration: activeObject.textDecoration,
                            //top: activeObject.top + activeObject.height / 2 + 10,
                            width: activeObject.width * activeObject.scaleX
                        });

                        if (activeObject.top + (activeObject.height * activeObject.scaleX / 2) > canvas.height / 2) {
                            $('#textArea').css({
                                top: parseInt(activeObject.top) - parseInt(activeObject.height * activeObject.scaleX / 2) - 20 - $('#textArea').height()
                            });
                        }
                        else {
                            $('#textArea').css({
                                top: activeObject.top + activeObject.height * activeObject.scaleX / 2 + 10
                            });
                        }
                    }
                    else {
                        $('#textArea').css({
                            fontFamily: activeObject.fontFamily,
                            fontStyle: activeObject.fontStyle,
                            fontWeight: activeObject.fontWeight,
                            height: activeObject.height,
                            left: activeObject.left - activeObject.width / 2,
                            textAlign: activeObject.textAlign,
                            textDecoration: activeObject.textDecoration,
                            top: activeObject.top - activeObject.height / 2,
                            width: activeObject.width
                        });
                    }

                    if (activeObject.fontFamily === 'PacificoRegular') {
                        $('#textArea').css({
                            marginTop: activeObject.scaleY * 0.25 + 'em'
                        });
                    }
                    else {
                        $('#textArea').css({
                            marginTop: 0
                        })
                    }
                });
            }

        }

        fabric.util.addListener(fabric.document, 'dblclick', dblClickHandler);
        // fabric.util.removeListener(canvas_ctx.upperCanvasEl, 'dblclick', dblClickHandler);

//        Set Tab key to deselect current text object if focus is in text area
        $('#textArea').live('keyup', function (e) {
            var keyCode = e.keyCode || e.which;
            if (keyCode == 9) {

                e.preventDefault();

                canvas.deactivateAll().renderAll();
                $('#textArea').val('').blur();
            }
        });

        canvas.observe('selection:cleared', function (e) {
            $('#textArea').val('').css({'display': 'none'});
        });

        canvas.observe('object:selected', function (e) {
            // set text box to display : none;
            $('#textArea').css({display: "none"});

            var activeObject = canvas.getActiveObject();
            //alert('sdf1');
            if (activeObject.selectable) {
                //alert('sdf2');
                var activeObjectFill = canvas.getActiveObject().fill;
            }

            canvas.calcOffset();

            if (!activeObject.get("engraved") && activeObject.selectable) {
                if (activeObject.type == "text") {
                    $('#textColor').spectrum("set", activeObjectFill);
                }
            }
        });

        var textEl = $('#textArea');
        if (textEl) {
            textEl.keyup(function (e) {
                var activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type == "text") {

                    canvas.fire('object:modified', { target: canvas.getActiveObject() });

                    if (this.value == "" || this.value == "\n") {
                        this.value = " ";
                        this.setSelectionRange(0, 0);
                    }
                    else if (this.value.length == 2 && this.value[1] == " ") {
                        this.value = this.value.substring(0, 1);
                        this.setSelectionRange(1, 1);
                    }


                    activeObject.text = this.value;

                    canvas.renderAll();
                    // dfdf

                }
            });
        }


        $('#fontFamily').change(function () {
            var fontFamily = $(this).val();
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.fontFamily = (activeObject.fill == fontFamily ? '' : fontFamily);
                canvas.renderAll();

            }
        });

        $('.showPaletteOnly').change(function (e) {
            var fillColor = $(this).val();
            var activeObject = canvas.getActiveObject();
            if (activeObject && (fillColor != activeObject.fill) && activeObject.selectable) {
                if (fillColor == "#000" && activeObject.fill == "#000000") {
                    // alert("black match : " + fillColor);
                }
                else {
                    //alert("Color Change Fire (" + activeObject.fill + " " + fillColor + ") ");
                    activeObject.fill = fillColor;
                    activeObject.setOpacity(1);
                    activeObject.stroke = null;
                    canvas.renderAll();
                    canvas.fire('object:modified', { target: canvas.getActiveObject() });

                }
            }

        });

        $('#borderColor').change(function () {
//            canvas.fire('object:modified', { target: canvas.getActiveObject() });
            var strokeColor = $(this).val();

            borderSingle.stroke = strokeColor;
            borderDouble.stroke = strokeColor;
            borderScalloped.stroke = strokeColor;

            borderSingle.opacity = 1;
            borderDouble.opacity = 1;
            borderScalloped.opacity = 1;

            borderSingle.engraved = false;
            borderDouble.engraved = false;
            borderScalloped.engraved = false;

            canvas.renderAll();

            ignor_last_action = false;
            canvas.fire('object:modified', { target: borderSingle });
        });

        $('#textBold').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.fontWeight = (activeObject.fontWeight == 'bold' ? '' : 'bold');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textItalic').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                console.log(activeObject.fontStyle);
                activeObject.fontStyle = (activeObject.fontStyle == 'italic' ? '' : 'italic');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textUnderline').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textDecoration = (activeObject.textDecoration == 'underline' ? '' : 'underline');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textStrikethrough').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textDecoration = (activeObject.textDecoration == 'line-through' ? '' : 'line-through');
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#alignLeft').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textAlign = 'left';
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#alignCenter').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textAlign = 'center';
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#alignRight').click(function () {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.textAlign = 'right';
                canvas.renderAll();
                canvas.fire('object:modified', { target: canvas.getActiveObject() });
            }
        });

        $('#textEngraved, #shapeEngraved').click(function () {
            var activeObject = canvas.getActiveObject();

            if (activeObject) {

                activeObject.set({engraved: true});
                console.log(activeObject);

                if (activeObject.type == "path" || activeObject.type == "polygon" || activeObject.type == "rect" || activeObject.type == "circle" || activeObject.type == "ellipse" || activeObject.type == "triangle") {
                    activeObject.setColor("#000000");
                    activeObject.setOpacity("0.3");

//                    activeObject.setPatternFill({
//                        source: $("#engravedbg").attr("src")
//                    });

                    activeObject.set({ strokeWidth: (1 / activeObject.scaleX ), stroke: 'rgba(0,0,0,1)', strokeDashArray: [3 / activeObject.scaleX, 2 / activeObject.scaleX] });

                    canvas.renderAll();
                    canvas.fire('object:modified', { target: canvas.getActiveObject() });
                }

                // text decoration
                if (activeObject.type == "text") {
                    activeObject.fill = "#000000";
                    activeObject.opacity = "0.3";

                    console.log(canvas.item(0)._element.src);
                    // console.log(canvas.item(0).outerHTML());


//                    activeObject.setPatternFill({
//                        source: $("#engravedbg").attr("src")
//                    });

                    activeObject.set({ strokeWidth: (1 / activeObject.scaleX ), stroke: 'rgba(0,0,0,1)', strokeDashArray: [3 / activeObject.scaleX, 2 / activeObject.scaleX] });

                    canvas.renderAll();
                    canvas.fire('object:modified', { target: canvas.getActiveObject() });
                }
            }
        });

        $('#borderEngraved').click(function () {
//            canvas.fire('object:modified', { target: canvas.getActiveObject() });
            borderSingle.set({engraved: true}).setOpacity("0.3");
            borderDouble.set({engraved: true}).setOpacity("0.3");
            borderScalloped.set({engraved: true}).setOpacity("0.3");

            borderSingle.stroke = "#000000";
            borderDouble.stroke = "#000000";
            borderScalloped.stroke = "#000000";

            ignor_last_action = false;
            canvas.fire('object:modified', { target: borderSingle });

            canvas.renderAll();
        });

        $('#flipX').click(function () {
            var activeObject = canvas.getActiveObject();
            activeObject.flipX = (activeObject.flipX != true);
            canvas.renderAll();
        });

        $('#flipY').click(function () {
            var activeObject = canvas.getActiveObject();
            activeObject.flipY = (activeObject.flipY != true);
            canvas.renderAll();
        });

        $('#bringForward').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.bringForward(activeObject);
            canvas.renderAll();
        });

        $('#bringToFront').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.bringToFront(activeObject);
            canvas.renderAll();
        });

        $('#sendBackwards').click(function () {
            var activeObject = canvas.getActiveObject();


            if (canvas.getObjects().indexOf(canvas.getActiveObject()) > 1 && (canvas.getObjects()[0] && canvas.getObjects()[0].selectable == false)) {
                canvas.sendBackwards(activeObject);
            }
            canvas.renderAll();
        });

        $('#sendToBack').click(function () {
            var activeObject = canvas.getActiveObject();
            canvas.sendToBack(activeObject).bringForward((activeObject));
            canvas.renderAll();
        });

        $('#deleteActiveObject').click(function () {
            var activeObject = canvas.getActiveObject(),
                    activeGroup = canvas.getActiveGroup();
            if (activeObject) {

                canvas.fire('object:removed', { target: canvas.getActiveObject() });
                canvas.remove(activeObject);
            }
            else if (activeGroup) {
                var objectsInGroup = activeGroup.getObjects();
                canvas.discardActiveGroup();
                objectsInGroup.forEach(function (object) {
                    canvas.fire('object:removed', { target: canvas.getActiveObject() });
                    canvas.remove(object);
                });
            }
        });

        $('#cloneActiveObject').click(function () {
            var activeObject = canvas.getActiveObject();
            var activeGroup = canvas.getActiveGroup();

            if (activeObject) {
                // alert('cloneing in progress');

                // clone works differently for text and shape / group

                // function handels path
                var clonedObject = activeObject.clone(function (clone) {
                    clone.set({ top: canvas.getActiveObject().get('top') + 10, left: canvas.getActiveObject().get('left') + 10, hasRotatingPoint: true });
                    clone.set({
                        borderColor: 'cyan',
                        cornerColor: 'cyan'
                    });
                    canvas.add(clone);

                    canvas.setActiveObject(clone);

                    canvas.renderAll();
                });

                // this will handel text
                if (clonedObject) {
                    clonedObject.set({ top: canvas.getActiveObject().get('top') + 10, left: canvas.getActiveObject().get('left') + 10, hasRotatingPoint: true });
                    clonedObject.set({
                        borderColor: 'cyan',
                        cornerColor: 'cyan'
                    });
                    canvas.add(clonedObject);

                    canvas.setActiveObject(clonedObject);

                    canvas.renderAll();
                }


            }
            else if (activeGroup) {
                var selection = activeGroup.getObjects();
                canvas.deactivateAll();
                var clones = [];
                selection.forEach(function (v, i) {
                    var clone = v.clone();
                    clone.set({ top: v.get('top') + 10,
                        left: v.get('left') + 10,
                        hasRotatingPoint: true,
                        borderColor: 'cyan',
                        cornerColor: 'cyan'
                    });
                    canvas.add(clone);
                    clone.setActive(true);
                    clones.push(clone);
                });
                var group = new fabric.Group(clones);
                canvas.setActiveGroup(group);
                group.saveCoords();
                canvas.renderAll();
            }
        });

        $('#shapeSelect').change(function () {
            if ($(this).val() != "") {
                var svg = "/assets/svg/" + $(this).val() + ".svg";

                // handel the uploads from admin
                if (!isNaN($(this).val().replace("id_", ""))) {
                    svg = "/custom_sign/get_custom_shape_svg/" + $(this).val().toLowerCase().replace("id_", "") + ".svg"
                }


                fabric.loadSVGFromURL(svg, function (objects, options) {
                    var obj = fabric.util.groupSVGElements(objects, options);
                    /*var ctx = canvas.getContext();
                     ctx.shadowColor = "rgba(255,255,255,0.75)";
                     ctx.shadowBlur = 0;
                     ctx.shadowOffsetX = 0;
                     ctx.shadowOffsetY = 1;*/
                    // set the position
                    obj.set('left', canvas.getCenter().left);
                    obj.set('top', canvas.getCenter().top);

                    obj.scale(canvasScale);

                    obj.setCoords();
                    obj.fill = $('#shapeColor').val();
                    obj.hasRotatingPoint = true;
                    obj.set({
                        borderColor: 'cyan',
                        cornerColor: 'cyan'
                    });

                    captureCurrentState();

                    canvas.add(obj);

                    canvas.setActiveObject(obj);
                    canvas.renderAll();

                    // call modified

                    // canvas.fire('object:modified', { target: obj });

                    // set $(this).val() to nothing
                    $("#shapeSelect").select2("val", "");
                });
            }
        });

        SetupBorder();


        setupScrewholes();
        setupMargins();


        var disabledTools = $('#deleteActiveObject, #cloneActiveObject, #bringForward, #sendBackwards, #flipY, #flipX');

        canvas.observe('object:selected', function () {
            var activeObject = canvas.getActiveObject();
            $(disabledTools).removeClass('disabled');
            if (activeObject && activeObject.type === 'text') {
                $('#addTextMenu').show();
                $('#addShapeMenu').hide();
                $('#addBorderMenu').hide();
                // set patal color
                if (!activeObject.engraved) {
                    $("#textColor").spectrum("set", activeObject.fill)
                }
            }
            if (activeObject && activeObject.type === 'path') {
                $('#addShapeMenu').show();
                $('#addTextMenu').hide();
                $('#addBorderMenu').hide();
                // set palet color
                if (!activeObject.engraved) {
                    // alert(activeObject.fill);
                    $("#shapeColor").spectrum("set", activeObject.fill)
                }
            }
        });

        canvas.observe('object:scaling', function () {
            var engraved = false;

            var activeObject = canvas.getActiveObject();

            if (activeObject && activeObject.get("engraved")) {
                engraved = true;
            }


            // style fill and stroke up
            if (engraved) {
                activeObject.set({ strokeWidth: (1 / activeObject.scaleX ), stroke: 'rgba(0,0,0,1)', strokeDashArray: [3 / activeObject.scaleX, 2 / activeObject.scaleX]});
                // console.log("object scaling : " + engraved);
            }
        });

        canvas.observe('selection:created', function () {
            $(disabledTools).removeClass('disabled');
        });

        canvas.observe('selection:cleared', function () {
            $(disabledTools).addClass('disabled');
        });

        <% unless params["id"].nil? %>
//        jQuery.ajax("/custom_sign/load_sign_ajax?saved_sign_id=
        //
        /*

        <%# =params["id"]%>").done(function(){
         */
//            alert("done");
//            alert($("#sign_data").val());
//            //canvas.loadFromJSON($("#sign_data").val());
//        });

        /*$("#sign_data").val('
        <%= @sign_data.sign_data %>');
         alert($("#sign_data").val());
         */
        <% end %>

    }

    $("#addBorder").on("click", function () {
        // deselect active object
        canvas.deactivateAll().renderAll();
    });

    $('#borderSelect').change(function () {
        var borderSelect = $('#borderSelect option:selected').val();

        if (borderSelect == "noborder") {
            ignor_last_action = true;
            canvas.remove(borderSingle);
            ignor_last_action = true;
            canvas.remove(borderDouble);
            ignor_last_action = true;
            canvas.remove(borderScalloped);
        }

        else if (borderSelect == "single") {
            ignor_last_action = true;
            canvas.add(borderSingle.scale(canvasScale)).centerObject(borderSingle).sendToBack(borderSingle).bringForward(borderSingle);
            ignor_last_action = true;
            canvas.remove(borderDouble);
            ignor_last_action = true;
            canvas.remove(borderScalloped);
        }
        else if (borderSelect == "double") {
            ignor_last_action = true;
            canvas.add(borderDouble.scale(canvasScale)).centerObject(borderDouble).sendToBack(borderDouble).bringForward(borderDouble);
            ignor_last_action = true;
            canvas.remove(borderSingle);
            ignor_last_action = true;
            canvas.remove(borderScalloped);
        }
        else if (borderSelect == "scalloped") {
            ignor_last_action = true;
            canvas.add(borderScalloped.scale(canvasScale)).centerObject(borderScalloped).sendToBack(borderScalloped).bringForward(borderScalloped);
            ignor_last_action = true;
            canvas.remove(borderSingle);
            ignor_last_action = true;
            canvas.remove(borderDouble);
        }

        ignor_last_action = false;
        canvas.fire('object:modified', { target: borderSingle });
    });


    <% if @sign_data.based_on.nil? %>
    $('#clearCanvas').click(function () {
        if (confirm('Are you sure?')) {
            var toRemove = [];
            $.each(canvas.getObjects(), function (i, e) {
                if (e.selectable) {
                    toRemove.push(e);
                }
            });

            while (toRemove.length > 0) {
                canvas.remove(toRemove.pop());
            }
        }


        $(disabledTools).addClass('disabled');
    });

    $('#loadCanvas').click(function () {
        if (confirm('Are you sure?\nYou will loose any changes you have made')) {
            window.location.href = "/members/welcome";
        }

        $(disabledTools).addClass('disabled');
    });


    <% else %>
    $('#clearCanvas').click(function () {
        if (confirm('Are you sure?')) {
            canvas.clear();
            $.ajax({
                url: "/custom_sign/reset_sign_data_ajax",
                data: { id: <%= @sign_data.based_on.to_s %> }
            }).done(function (result) {
                        $("#sign_data").val(result.sign_data);
                        var jsn = $.base64.decode($("#sign_data").val());
                        canvas.loadFromJSON(jsn);
                    });
        }
        $(disabledTools).addClass('disabled');
    });
    <% end %>

    $('#startagain').click(function () {
        if (confirm('Are you sure?')) {
            var url = window.location.href;

            if (url.indexOf("from_last_session") > 0 || url.indexOf("edit_sign") > 0) {
                window.location.href = url;
            }
            else {

                window.location.href = url + "&from_last_session=true";

            }

        }

        $(disabledTools).addClass('disabled');
    })
    ;

    $('#zoomIn').click(function () {
        if (canvasScale < 3.375) {
            canvasScale = canvasScale * 1.5;
            canvas.setHeight(canvas.getHeight() * 1.5);
            canvas.setWidth(canvas.getWidth() * 1.5);
            var obj = canvas.getObjects();
            for (var i in obj) {
                var scaleX = obj[i].get('scaleX');
                var scaleY = obj[i].get('scaleY');
                var left = obj[i].get('left');
                var top = obj[i].get('top');

                var tempScaleX = scaleX * 1.5;
                var tempScaleY = scaleY * 1.5;
                var tempLeft = left * 1.5;
                var tempTop = top * 1.5;

                obj[i].set('scaleX', tempScaleX);
                obj[i].set('scaleY', tempScaleY);
                obj[i].set('left', tempLeft);
                obj[i].set('top', tempTop);

                obj[i].setCoords();
            }
        }
        applyMask();
        canvas.renderAll();
        canvas.calcOffset();
        $('#canvasScale').text(Math.round(canvasScale * 100) + "%");
        var rightvalue = ($('.canvas-container').parent().width() - $('.canvas-container').width()) / 2 - $('#toolPalette').width() - 10;
        $('#toolPalette').css('right', rightvalue + 'px');


    });

    $('#addText').click(function () {
        $('#addTextMenu').show();
        $('#addShapeMenu').hide();
        $('#addBorderMenu').hide();
        var textValue = $('#textArea').val();
        var fontFamily = $('#fontFamily').val();
        var color = $('#textColor').val();
        var text = new fabric.Text(placeholderText, {
            fontFamily: fontFamily,
            fill: color,
            left: canvasWidth / 2,
            top: canvasHeight / 2
        });

        text.hasRotatingPoint = true;

        text.set({
            borderColor: 'cyan',
            cornerColor: 'cyan',
            fontWeight: "normal"
        });

        text.scale(canvasScale);
        canvas.setActiveObject(text);

        // make text selected
        canvas.add(text);


        // add timed event to refresh on first text eleemnt added
        if (textUpdateOnce == null) {
            textUpdateOnce = setInterval(function () {
                canvasUpdate()
            }, 100);
        }
        canvas.renderAll();
    });

    $('#addShape').click(function () {
        $('#addShapeMenu').show();
        $('#addTextMenu').hide();
        $('#addBorderMenu').hide();
    });

    $('#addBorder').click(function () {
        $('#addBorderMenu').show();
        $('#addTextMenu').hide();
        $('#addShapeMenu').hide();
    });

    $('#zoomOut').click(function () {
        if (canvasScale > 0.3) {
            canvasScale = canvasScale / 1.5;
            canvas.setHeight(canvas.getHeight() / 1.5);
            canvas.setWidth(canvas.getWidth() / 1.5);
            var obj = canvas.getObjects();
            for (var i in obj) {
                var scaleX = obj[i].get('scaleX');
                var scaleY = obj[i].get('scaleY');
                var left = obj[i].get('left');
                var top = obj[i].get('top');

                var tempScaleX = scaleX / 1.5;
                var tempScaleY = scaleY / 1.5;
                var tempLeft = left / 1.5;
                var tempTop = top / 1.5;

                obj[i].set('scaleX', tempScaleX);
                obj[i].set('scaleY', tempScaleY);
                obj[i].set('left', tempLeft);
                obj[i].set('top', tempTop);

                obj[i].setCoords();
            }
        }
        applyMask();
        canvas.renderAll();

        $('#canvasScale').text(Math.round(canvasScale * 100) + "%");

        var rightvalue = ($('.canvas-container').parent().width() - $('.canvas-container').width()) / 2 - $('#toolPalette').width() - 10;
        $('#toolPalette').css('right', rightvalue + 'px');

    });

    function SetupCanvasEventHooks(canvas) {


        canvas.observe('object:modified', function () {
            console.log("object:modified (track changes : " + canvas_track_changes + ", ignore last state : " + ignor_last_action + " )");
            if (canvas_track_changes && !ignor_last_action) {
                redoStack = [];
                appendToUndoStack();
                captureCurrentState();
            }
            else {
                ignor_last_action = false;
            }
        });

        canvas.observe('object:added', function () {
            console.log("object:added : " + canvas_track_changes + " " + !ignor_last_action);
            if (canvas_track_changes && !ignor_last_action) {

                redoStack = [];
                appendToUndoStack();
                captureCurrentState();
            }
            else {
                ignor_last_action = false;
            }
        });

        canvas.observe('object:removed', function () {
            console.log("object:removed");
            if (canvas_track_changes && !ignor_last_action) {
                redoStack = [];
                appendToUndoStack();
                captureCurrentState();
            }
            else {
                ignor_last_action = false;
            }
        });

        function CustomLoadFromHistory(prevObj) {
            var toRemove = [];

            $.each(canvas.getObjects(), function (i, e) {
                if (e.selectable || e.type != "image") {
                    toRemove.push(e);
                }
            });

            while (toRemove.length > 0) {
                ignor_last_action = true;
                canvas.remove(toRemove.pop());
            }

            $.each(prevObj.objects, function (i, e) {
                if (e.selectable || e.type != "image") {
                    ignor_last_action = true;
                    canvas.add(e); // add object
                }
            });

            // remove all borders
            canvas.renderAll();

            // set border options from stack
            SetupBorder(prevObj.border);

            canvas.renderAll();

            captureCurrentState();

            ignor_last_action = false;
        }


        $('#undo').click(function undo() {
            if (undoStack.length > 0) {
                captureCurrentState();
                appendToRedoStack();
                CustomLoadFromHistory(undoStack.pop());
                $("#redo").removeClass("disabled");
            }

            if (undoStack && undoStack.length == 0) {
                $("#undo").addClass("disabled");
            }
        });

        $('#redo').click(function redo() {

            if (redoStack.length > 0) {
                captureCurrentState();
                appendToUndoStack();
                CustomLoadFromHistory(redoStack.pop());

                $("#undo").removeClass("disabled");
            }

            console.log("redo stack length : " + redoStack.length);
            if (redoStack.length == 0) {
                $("#redo").addClass("disabled");
            }
        });

        canvas_track_changes = true;
    }

    function appendToUndoStack() {
        console.log("Adding to undo stack, size : " + undoStack.length.toString());
        undoStack.push(currentState);
        $("#undo").removeClass("disabled");
        // $("#redo").addClass("disabled");
    }

    function appendToRedoStack() {
        console.log("Adding to redo stack, size : " + redoStack.length.toString());
        redoStack.push(currentState);
        if (undoStack && undoStack.length == 0) {
            $("#undo").addClass("disabled");
        }

        $("#redo").removeClass("disabled");
    }

    function captureCurrentState() {
        console.log("current state captured");
//        alert("captured");
        // reset the redo stack
        var hist = {};

        hist.objects = [];
        hist.border = {
            style: $('#borderSelect option:selected').val(),
            color: $("#borderColor").val(),
            engraved: !!(borderSingle.engraved == true),
            width: borderSingle.strokeWidth };

        $.each(canvas.getObjects(), function (i, e) {
            if (e.selectable && e.type != "image") {
                hist.objects.push(jQuery.extend(true, {}, e));
            }
        });


        currentState = hist;
    }

    function applyMask() {
        if (mask_svg_url != "") {
            var tempContext = canvas.getContext("2d");

            fabric.loadSVGFromURL(mask_svg_url, function (objects, options) {
                var mask = fabric.util.groupSVGElements(objects, options);

                mask.scaleX = canvas.width / mask.width;
                mask.scaleY = canvas.height / mask.height;
                mask.top = canvas.height / 2;
                mask.left = canvas.width / 2;
                canvas.clipTo = (function (ctx) {
                    mask.render(ctx);
                });

                canvas.renderAll();

            });


            // add mask as canvas object, for when storing the SVG
            fabric.loadSVGFromURL(mask_svg_url, function (objects, options) {
                mask_object = fabric.util.groupSVGElements(objects, options);

                mask_object.scaleX = canvas.width / mask_object.width;
                mask_object.scaleY = canvas.height / mask_object.height;
                mask_object.top = canvas.height / 2;
                mask_object.left = canvas.width / 2;

                // mask_object.set({ strokeWidth: (1 / mask_object.scaleX ), stroke: '#000000', strokeDashArray: [6 / mask_object.scaleX, 1 / mask_object.scaleX], fill: 'none', opacity: 0});
                mask_object.set({ strokeWidth: (1 / mask_object.scaleX ), stroke: 'none', strokeDashArray: [6 / mask_object.scaleX, 1 / mask_object.scaleX], fill: 'transparent', opacity: 1});

                mask_object.selectable = false;

                ignor_last_action = true;
                console.log("Adding mask");
                canvas.add(mask_object).bringToFront(mask_object);

                canvas.renderAll();
                //
                // alert("sdfsdf");

            });
        }
    }

    function type(o) {
        return !!o && Object.prototype.toString.call(o).match(/(\w+)\]/)[1];
    }

    function addBackingImage() {
        var bg_image_url = '';


        //this is where the background image is set. Need to think about how to store and recall this.
        <% background_image = @sign_data.get_background_image %>

        <% if background_image.nil? %>

//        canvas.setBackgroundImage('/assets/customisation/brass_test.jpg', function () {
////            canvas.item(0).scaleToWidth(canvas.getWidth());
//            canvas.renderAll();
//        });

        bg_image_url = '/assets/customisation/slate.jpg';

        <% else %>

        bg_image_url = '<%= background_image.attachment.url(:product) %>';
        canvas.setBackgroundImage(bg_image_url, function () {
            //canvas.setBackgroundImage('/assets/customisation/brass.jpg', function () {

            canvas.renderAll();
        });

        <% end %>

        canvas_track_changes = false;
        console.log('canvas_track_changes : ' + canvas_track_changes);

        ignor_last_action = true;

        fabric.Image.fromURL(bg_image_url, function (oImg) {
            if ((canvas.width / canvas.height) > (oImg.width / oImg.height)) {
                oImg.scaleToWidth(canvasWidth);
            }
            else {
                // portrait
                oImg.scaleToHeight(canvasHeight);
            }

            oImg.top = canvasHeight / 2;
            oImg.left = canvasWidth / 2;

            oImg.selectable = false;
            canvas.add(oImg).sendToBack(oImg);
        });
    }

    function addMask() {
        mask_svg_url = "<%= @sign_data.get_mask %>";

        applyMask();

        //canvas_track_changes = true;
        console.log('canvas_track_changes : ' + canvas_track_changes);
    }

    function updateSVGfield() {
        // show mask
        canvas.bringToFront(mask_object);
        mask_object.set({stroke: 1});

        canvas.renderAll();

        // get svg data
        var svg_data = canvas.toSVG();
        $("#svg_data").val(svg_data);

        // hide mask
        mask_object.set({stroke: "none"});

        canvas.renderAll();
    }

    function reloadSign() {
//    alert("canvas objects : " + canvas.getObjects().length);

        $("#sign_data").val('<%= @sign_data.sign_data %>');

        if ($("#sign_data").val() != '') {
            //alert("Saved sign loaded!");
            var jsn = $.base64.decode($("#sign_data").val());
            // console.log(jQuery.parseJSON( jsn ).border);


//            $.each(jsn["objects"], function(e, i){
//                                             console.log(e);
//            });

            canvas.loadFromJSON(jsn, function () {
                alert("loading sign");
                var toRemove = [];

                $.each(canvas.getObjects(), function (i, e) {
                    if (e.selectable && e.type == "image") {
                        toRemove.push(e);
                    }
                });

                // alert("object count : " + canvas.getObjects().length);

                if (toRemove.length > 0) {
                    while (toRemove.length > 0) {
                        canvas.remove(toRemove.pop());
                    }
                }

//                var add_back = [];
                $.each(canvas.getObjects(), function (i, e) {
                    if (e.selectable) {
//                        add_backpush(e);
//                        canvas.remove(e);
                        e.set({
                            borderColor: 'cyan',
                            cornerColor: 'cyan'
                        });
                    }
                });

//                $.each(add_back, function (i, e) {
//                    alert("addubg");
//                    canvas.add(e);
//                });


                setupMargins();
                setupScrewholes();

                //addBackingImage();
                addMask();

                canvas.calcOffset();


                //alert("object count : " + canvas.getObjects().length);
                canvas.renderAll();

                textUpdateOnce = setInterval(function () {
                    canvasUpdate();
                }, 500);
            });



            // address border element

            SetupBorder(jQuery.parseJSON(jsn).border);


//        alert("canvas objects : " + canvas.getObjects().length);

            $("#name").val("<%= @sign_data.name %>");
            $("#description").val("<%= @sign_data.description %>");
        }
    }

    function getCanvasJSONCustom() {

        var json = {
            objects: [],
            background: "",
            border: {
                style: $('#borderSelect option:selected').val(),
                color: $("#borderColor").val(),
                engraved: !!(borderSingle.engraved == true),
                width: borderSingle.strokeWidth }};

        $.each(canvas.getObjects(), function (i, e) {
            if (e.selectable) {
                json.objects.push(e);
            }
        });

        console.log(json);

        console.log(JSON.stringify(json));

        return JSON.stringify(json);
    }

    function setupScrewholes() {
        var in_by = 35;

        screwholesarray = [];

        //Top Left Screw Hole
        var topLeftScrewHole = new fabric.Circle({
            left: in_by,
            top: in_by,
            radius: 10,
            selectable: false
        });

        topLeftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        //Top Left Screw Hole
        var topScrewHole = new fabric.Circle({
            left: canvasWidth / 2,
            top: in_by,
            radius: 10,
            selectable: false
        });

        topScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var topRightScrewHole = new fabric.Circle({
            left: canvasWidth - in_by,
            top: in_by,
            radius: 10,
            selectable: false
        });

        topRightScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var rightScrewHole = new fabric.Circle({
            left: canvasWidth - in_by,
            top: canvasHeight / 2,
            radius: 10,
            selectable: false
        });

        rightScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var leftScrewHole = new fabric.Circle({
            left: in_by,
            top: canvasHeight / 2,
            radius: 10,
            selectable: false
        });

        leftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: topRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var bottomRightScrewHole = new fabric.Circle({
            left: canvasWidth - in_by,
            top: canvasHeight - in_by,
            radius: 10,
            selectable: false
        });

        bottomRightScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: bottomRightScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var bottomLeftScrewHole = new fabric.Circle({
            left: in_by,
            top: canvasHeight - in_by,
            radius: 10,
            selectable: false
        });

        bottomLeftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: bottomLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });

        var bottomScrewHole = new fabric.Circle({
            left: canvasWidth / 2,
            top: canvasHeight - in_by,
            radius: 10,
            selectable: false
        });

        bottomLeftScrewHole.setGradient({
            x1: 0,
            y1: 0,
            x2: 0,
            y2: bottomLeftScrewHole.height,
            colorStops: {
                0: '#000',
                1: '#25393b'
            }
        });


        var outerScrewHoleTL = new fabric.Circle({
            left: -20,
            top: -20,
            radius: 10,
            selectable: false
        });

        var outerScrewHoleTR = new fabric.Circle({
            left: canvasWidth + 20,
            top: -20,
            radius: 10,
            selectable: false
        });

        var outerScrewHoleBL = new fabric.Circle({
            left: -20,
            top: canvasHeight + 20,
            radius: 10,
            selectable: false
        });

        var outerScrewHoleBR = new fabric.Circle({
            left: canvasWidth + 20,
            top: canvasHeight + 20,
            radius: 10,
            selectable: false
        });


        <% if @sign_data.get_base_shape().screw_hole_bottom_left %>
        screwholesarray.push(bottomLeftScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_bottom %>
        screwholesarray.push(bottomScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_bottom_right %>
        screwholesarray.push(bottomRightScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_left %>
        screwholesarray.push(leftScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_right %>
        screwholesarray.push(rightScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_top_left %>
        screwholesarray.push(topLeftScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_top %>
        screwholesarray.push(topScrewHole);
        <% end %>

        <% if @sign_data.get_base_shape().screw_hole_top_right %>
        screwholesarray.push(topRightScrewHole);
        <% end %>

        // add screwhomes to llow centering to occur correctly
        screwholesarray.push(outerScrewHoleBL);
        screwholesarray.push(outerScrewHoleBR);
        screwholesarray.push(outerScrewHoleTL);
        screwholesarray.push(outerScrewHoleTR);

        var screwHoles = new fabric.Group(screwholesarray, {selectable: false});
        console.log(screwHoles);

        $('#toggleScrewHoles').toggle(function () {
            ignor_last_action = true;
            canvas.add(screwHoles.scale(canvasScale)).centerObject(screwHoles).bringToFront(screwHoles).sendBackwards(screwHoles);
            $(this).addClass("active");
        }, function () {
            ignor_last_action = true;
            canvas.remove(screwHoles);
            $(this).removeClass("active");
        });
    }

    function setupMargins() {
        var leftMargin = new fabric.Line([40, 0, 40, canvasHeight], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });
        var topMargin = new fabric.Line([0, 40, canvasWidth, 40], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });
        var rightMargin = new fabric.Line([canvasWidth - 40, 0, canvasWidth - 40, canvasHeight], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });
        var bottomMargin = new fabric.Line([0, canvasHeight - 40, canvasWidth, canvasHeight - 40], {
            stroke: 'cyan',
            opacity: 0.5,
            selectable: false
        });

        var margins = new fabric.Group([leftMargin, topMargin, rightMargin, bottomMargin], {selectable: false});

        $('#toggleMargins').toggle(function () {
            // margins.scale(canvasScale);

            ignor_last_action = true;
            canvas.add(margins).bringToFront(margins);
            ignor_last_action = true;
            canvas.centerObject(margins);
            ignor_last_action = true;
            canvas.sendToBack(margins);
            ignor_last_action = true;
            canvas.bringForward(margins);

            $(this).addClass("active");
        }, function () {
            ignor_last_action = true;
            canvas.remove(margins);
            $(this).removeClass("active");
        });
    }

    function GetBase64PNG() {
        // hide object selection
        var obj = canvas.getActiveObject();

        canvas.deactivateAll();
        canvas.renderAll();

        var str = canvas.toDataURL({multiplier: 1});

        // show object selection
        if (obj != null) {
            canvas.setActiveObject(obj);
            canvas.renderAll();
        }

        return str;
    }

    function IsFireFox() {
        return !!navigator.userAgent.match(/firefox/i);
    }

    function SetupBorder(settings) {

        // remove any borders from canvas
        canvas.remove(borderSingle);
        canvas.remove(borderDouble);
        canvas.remove(borderScalloped);

        if (borderSingle == null) {
            console.log("setting up borders");
            console.log(settings);
            var borderInset = 50, scallopDepth = 70, borderX = canvasWidth - borderInset, borderY = canvasHeight - borderInset, scallopX = canvasWidth - scallopDepth, scallopY = canvasHeight - scallopDepth;

            borderSingle = new fabric.Path([
                ['M', borderInset, borderInset],
                ['V', borderY],
                ['H', borderX],
                ['V', borderInset],
                ['H', borderInset]
            ], {
                fill: '',
                height: canvasHeight,
                selectable: false,
                stroke: 'black',
                width: canvasWidth,
                strokeLineCap: "square"
            });

            borderDouble = new fabric.Path([
                ['M', borderInset, borderInset],
                ['V', borderY],
                ['H', borderX],
                ['V', borderInset],
                ['H', borderInset],
                ['M', scallopDepth, scallopDepth],
                ['V', canvasHeight - scallopDepth],
                ['H', canvasWidth - scallopDepth],
                ['V', scallopDepth],
                ['H', scallopDepth]
            ], {
                fill: '',
                height: canvasHeight,
                selectable: false,
                stroke: 'black',
                width: canvasWidth,
                strokeLineCap: "square"
            });

            borderScalloped = new fabric.Path([
                ['M', scallopDepth, borderInset],
                ['Q', scallopDepth, scallopDepth, borderInset, scallopDepth],
                ['V', scallopY],
                ['Q', scallopDepth, scallopY, scallopDepth, canvasHeight - borderInset],
                ['H', scallopX],
                ['Q', scallopX, scallopY, canvasWidth - borderInset, scallopY],
                ['V', scallopDepth],
                ['Q', scallopX, scallopDepth, scallopX, borderInset],
                ['H', scallopDepth]
            ], {
                fill: '',
                height: canvasHeight,
                selectable: false,
                stroke: 'black',
                width: canvasWidth,
                strokeLineCap: "square"
            });
        }

        if (settings != null) {

            console.log("applying settings");


            if (settings.style == "noborder") {
                //$("#borderSelect").select2().val(settings.style);
                //$("#borderThicknessSlider").slider('value', settings.width.toString());

                console.log(settings.style);
                // remove all
                ignor_last_action = true;
                canvas.remove(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderDouble);
                ignor_last_action = true;
                canvas.remove(borderScalloped);
            }

            if (settings.style == "single") {
                $("#borderSelect").select2().val(settings.style);
                $("#borderThicknessSlider").slider('value', settings.width.toString());

                console.log(settings.style);
                // remove all
                ignor_last_action = true;
                canvas.add(borderSingle.scale(canvasScale)).centerObject(borderSingle).sendToBack(borderSingle).bringForward(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderDouble);
                ignor_last_action = true;
                canvas.remove(borderScalloped);
            }

            if (settings.style == "double") {
                $("#borderSelect").select2().val(settings.style);
                $("#borderThicknessSlider").slider('value', settings.width.toString());

                console.log(settings.style);
                // remove all
                canvas.remove(borderSingle);
                ignor_last_action = true;
                canvas.add(borderDouble.scale(canvasScale)).centerObject(borderDouble).bringToFront(borderDouble)// sendToBack(borderDouble).bringForward(borderDouble);
                ignor_last_action = true;
                canvas.remove(borderScalloped);
                ignor_last_action = true;
            }

            if (settings.style == "scalloped") {
                $("#borderSelect").select2().val(settings.style);
                $("#borderThicknessSlider").slider('value', settings.width.toString());

                console.log(settings.style);
                // remove all
                ignor_last_action = true;
                canvas.remove(borderSingle);
                ignor_last_action = true;
                canvas.remove(borderDouble);
                ignor_last_action = true;
                canvas.add(borderScalloped.scale(canvasScale)).centerObject(borderScalloped).sendToBack(borderScalloped).bringForward(borderScalloped);

            }

            borderSingle.set({
                strokeWidth: settings.width
            });
            borderDouble.set({
                strokeWidth: settings.width
            });
            borderScalloped.set({
                strokeWidth: settings.width
            });

            if (settings.engraved) {
                // set the border color

                borderSingle.stroke = "#000000";
                borderDouble.stroke = "#000000";
                borderScalloped.stroke = "#000000";

                borderSingle.opacity = 0.3;
                borderDouble.opacity = 0.3;
                borderScalloped.opacity = 0.3;
            }
            else {
                // set the border color

                $("#shapeSelect").select2("val", settings.color);

                $("#borderColor").val(settings.color);

                borderSingle.stroke = settings.color;
                borderDouble.stroke = settings.color;
                borderScalloped.stroke = settings.color;

                borderSingle.opacity = 1;
                borderDouble.opacity = 1;
                borderScalloped.opacity = 1;
            }

            canvas.renderAll();

        }
    }


</script>